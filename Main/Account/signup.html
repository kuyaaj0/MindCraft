<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sign Up | MindCraft</title>

<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@600;700;800&display=swap" rel="stylesheet">

<style>
* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'Baloo 2', cursive;
  min-height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
  background: linear-gradient(to bottom, #8fe9ff, #c8f7b0);
  position: relative;
}

body::before {
  content: "";
  position: absolute;
  inset: 0;
  background:
    radial-gradient(circle at 20% 30%, #fff 2px, transparent 3px),
    radial-gradient(circle at 70% 20%, #fff 2px, transparent 3px),
    radial-gradient(circle at 40% 80%, #fff 2px, transparent 3px);
  opacity: 0.25;
  pointer-events: none;
  z-index: 0;
}

/* BACK BUTTON OUTSIDE PANEL */
.back-wrap {
  position: absolute;
  top: 24px;
  left: 24px;
  display: none;
  z-index: 10;
}
.back-btn {
  padding: 10px 18px;
  border-radius: 14px;
  border: none;
  background: #666;
  color: white;
  cursor: pointer;
  font-weight: 700;
  box-shadow: 0 4px 0 #444;
}
.back-btn:hover { background: #888; transform: translateY(-1px); }
.back-btn:active { transform: translateY(2px); }

/* HOME BUTTON (LEFT) */
.home-wrap {
  position: absolute;
  top: 24px;
  left: 24px; /* same left as back button */
  display: block;
  z-index: 10;
}
.home-btn {
  padding: 10px 18px;
  border-radius: 14px;
  border: none;
  background: #ffae42;
  color: #5a3a1a;
  cursor: pointer;
  font-weight: 700;
  box-shadow: 0 4px 0 #d8942f;
}
.home-btn:hover { transform: translateY(-1px); }
.home-btn:active { transform: translateY(2px); }

/* PANELS */
.panel {
  background: white;
  width: 400px;
  padding: 36px;
  border-radius: 26px;
  text-align: center;
  box-shadow: 0 14px 28px rgba(0,0,0,0.2);
  position: relative;
  z-index: 1;
}

.title { font-size: 38px; font-weight: 800; color: #5a3a1a; margin-bottom: 6px; }
.subtitle { font-size: 17px; color: #6d4c41; margin-bottom: 24px; }

input {
  width: 100%;
  padding: 13px;
  border-radius: 14px;
  border: none;
  background: #f3f3f3;
  font-size: 15px;
  margin-bottom: 12px;
}

button {
  width: 100%;
  background: #b8783d;
  color: white;
  border: none;
  border-radius: 18px;
  padding: 14px;
  font-size: 17px;
  font-weight: 700;
  cursor: pointer;
  box-shadow: 0 5px 0 #6b3e1a;
  transition: transform .15s ease;
}
button:hover { transform: translateY(-1px); }
button:active { transform: translateY(3px); }

.role-btn { margin-bottom: 12px; }

.message {
  margin-top: 10px;
  font-weight: 700;
  color: #c62828;
  font-size: 14px;
}

/* Toast */
.toast {
  position: fixed;
  bottom: 24px;
  right: 24px;
  background: #1db954;
  color: white;
  padding: 14px 18px;
  border-radius: 14px;
  font-weight: 700;
  opacity: 0;
  transform: translateY(20px);
  transition: 0.4s;
  z-index: 9999;
}
.toast.show { opacity: 1; transform: translateY(0); }
.toast.error { background: #c62828; }

/* Hide forms by default */
.student-form, .teacher-form { display: none; }

</style>
</head>

<body>

<!-- BACK BUTTON -->
<div class="back-wrap" id="backWrap">
  <button class="back-btn" id="backBtn">← Back</button>
</div>

<!-- HOME BUTTON (VISIBLE ONLY ON ROLE CHOICE) -->
<div class="home-wrap" id="homeWrap">
  <button class="home-btn" onclick="location.href='../../index.html'">Home</button>
</div>

<!-- ROLE CHOICE PANEL -->
<div class="panel" id="choiceSection">
  <div class="title">MindCraft</div>
  <div class="subtitle">Choose your role to sign up</div>

  <button class="role-btn" id="studentBtn">Student</button>
  <button class="role-btn" id="teacherBtn">Teacher</button>

  <div class="auth-link">
    Already have an account? <a href="signin.html">Sign in here</a>
  </div>
</div>

<!-- STUDENT SIGN UP PANEL -->
<div class="panel student-form" id="studentForm">
  <div class="title">Student Sign Up</div>

  <form id="studentSignupForm">
    <input type="text" id="studentName" placeholder="Full name" required>
    <input type="email" id="studentEmail" placeholder="Gmail address" required>
    <input type="password" id="studentPassword" placeholder="Password" required>
    <button type="submit">Create Account</button>
  </form>

  <p class="message" id="studentMessage"></p>
</div>

<!-- TEACHER SIGN UP PANEL -->
<div class="panel teacher-form" id="teacherForm">
  <div class="title">Teacher Sign Up</div>
  <div class="subtitle">DepEd email required</div>

  <form id="teacherSignupForm">
    <input type="text" id="teacherName" placeholder="Full name" required>
    <input type="email" id="teacherEmail" placeholder="DepEd email" required>
    <input type="password" id="teacherPassword" placeholder="Password" required>
    <button type="submit">Create Account</button>
  </form>

  <p class="message" id="teacherMessage"></p>
</div>

<!-- TOAST -->
<div id="toast" class="toast"></div>

<script type="module">
import { auth, db } from '../System/Database/firebase.js';
import { createUserWithEmailAndPassword, sendEmailVerification } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { setDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* ==== UI ELEMENTS ==== */
const studentBtn = document.getElementById("studentBtn");
const teacherBtn = document.getElementById("teacherBtn");
const choiceSection = document.getElementById("choiceSection");
const studentForm = document.getElementById("studentForm");
const teacherForm = document.getElementById("teacherForm");
const backWrap = document.getElementById("backWrap");
const backBtn = document.getElementById("backBtn");
const homeWrap = document.getElementById("homeWrap");

/* ==== UI TOGGLE ==== */
function showStudentForm() {
  choiceSection.style.display = "none";
  studentForm.style.display = "block";
  backWrap.style.display = "block";
  homeWrap.style.display = "none";
}

function showTeacherForm() {
  choiceSection.style.display = "none";
  teacherForm.style.display = "block";
  backWrap.style.display = "block";
  homeWrap.style.display = "none";
}

function backToChoice() {
  studentForm.style.display = "none";
  teacherForm.style.display = "none";
  choiceSection.style.display = "block";
  backWrap.style.display = "none";
  homeWrap.style.display = "block";

  studentSignupForm.reset();
  teacherSignupForm.reset();
  studentMessage.textContent = "";
  teacherMessage.textContent = "";
}

/* ==== EVENT LISTENERS ==== */
studentBtn.addEventListener("click", showStudentForm);
teacherBtn.addEventListener("click", showTeacherForm);
backBtn.addEventListener("click", backToChoice);

/* ==== TOAST ==== */
function showToast(msg, isError=false) {
  const toast = document.getElementById("toast");
  toast.textContent = msg;
  toast.className = "toast show" + (isError ? " error" : "");
  setTimeout(() => toast.className = "toast", 3000);
}

/* ==== STUDENT SIGN UP ==== */
const studentSignupForm = document.getElementById("studentSignupForm");
const studentName = document.getElementById("studentName");
const studentEmail = document.getElementById("studentEmail");
const studentPassword = document.getElementById("studentPassword");
const studentMessage = document.getElementById("studentMessage");

studentSignupForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const name = studentName.value.trim();
  const email = studentEmail.value.trim();
  const password = studentPassword.value;

  try {
    const user = await createUserWithEmailAndPassword(auth, email, password);

    // ✅ Create Firestore document and confirm write success
const userRef = doc(db, "users", user.user.uid);
await setDoc(userRef, {
  name,
  email,
  role: "student",
  verified: false,
  level: 1,
  xp: 0,
  xpMax: 100,
  totalXP: 0,
  completedLessons: [],
  completedQuizzes: [],
  createdAt: new Date()
});

// ✅ Delay before sending verification (ensure Firestore sync)
await new Promise(res => setTimeout(res, 1500));

// ✅ Send email verification
await sendEmailVerification(user.user);

// ✅ Optional update for Firestore consistency (in case of race condition)
await setDoc(userRef, { verified: false }, { merge: true });

    showToast("Verification email sent. Check Gmail inbox/spam.");
    studentMessage.style.color = "#1DB954";
    studentMessage.textContent = "Account created! Verify Gmail before signing in.";

    setTimeout(() => location.href = "signin.html", 4000);
  } catch (err) {
    console.error(err);
    studentMessage.style.color = "#c62828";
    studentMessage.textContent = err.message;
    showToast(err.message, true);
  }
});

/* ==== TEACHER SIGN UP ==== */
const teacherSignupForm = document.getElementById("teacherSignupForm");
const teacherName = document.getElementById("teacherName");
const teacherEmail = document.getElementById("teacherEmail");
const teacherPassword = document.getElementById("teacherPassword");
const teacherMessage = document.getElementById("teacherMessage");

teacherSignupForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const name = teacherName.value.trim();
  const email = teacherEmail.value.trim();
  const password = teacherPassword.value;

  if (!email.includes("@ed.gov") && !email.includes("@deped.gov.ph")) {
    teacherMessage.style.color = "#c62828";
    teacherMessage.textContent = "Invalid DepEd email address.";
    showToast("Invalid DepEd email.", true);
    return;
  }

  try {
    const user = await createUserWithEmailAndPassword(auth, email, password);

    await setDoc(doc(db, "users", user.user.uid), {
      name,
      email,
      role: "teacher",
      verified: true,
      createdAt: new Date()
    });

    showToast("Teacher account created successfully!");
    teacherMessage.style.color = "#1DB954";
    teacherMessage.textContent = "Teacher account created! You can now sign in.";

    setTimeout(() => location.href = "signin.html", 3000);
  } catch (err) {
    console.error(err);
    teacherMessage.style.color = "#c62828";
    teacherMessage.textContent = err.message;
    showToast(err.message, true);
  }
});
</script>

</body>
</html>
<!--fixed and needs to be tested so it would be my backup plan-->
