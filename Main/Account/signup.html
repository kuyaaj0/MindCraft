<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sign Up - MindCraft</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<link rel="stylesheet" href="../Design/Position.css"> <!-- Updated path -->
<style>
body {
  font-family: 'Press Start 2P', cursive;
  text-align: center;
  background: #203a43;
  color: white;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
}
input {
  padding: 10px;
  width: 70%;
  margin: 10px;
  border-radius: 8px;
  border: none;
  font-family: 'Press Start 2P', cursive;
  font-size: 0.6rem;
}
button {
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  background: #1DB954;
  color: white;
  cursor: pointer;
  font-family: 'Press Start 2P', cursive;
  font-size: 0.6rem;
  margin: 5px;
  transition: background 0.3s;
}
button:hover { background: #1ed760; }
button:disabled {
  background: #555;
  cursor: not-allowed;
}
.message { margin: 10px; color: #ff5252; font-size: 0.6rem; }
.choice-section, .student-form, .teacher-form { display: none; }
.choice-section { display: block; }

/* === Back Buttons === */
.back-buttons {
  position: absolute;
  top: 20px;
  left: 20px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.back-buttons button {
  width: 160px;
  background: #666;
}
.back-buttons button:hover { background: #888; }
</style>
</head>
<body>

<!-- üîô Back Buttons -->
<div class="back-buttons">
  <button id="homeBtn">üè† Home</button>
  <button id="formBackBtn" style="display:none;">‚¨Ö Back to Form</button>
</div>

<!-- Choice Section -->
<div class="choice-section" id="choiceSection">
  <h2>üß† MindCraft - Sign Up</h2>
  <p>Choose your role:</p>
  <button id="studentBtn">Student</button>
  <button id="teacherBtn">Teacher</button>
</div>

<!-- Student Form -->
<div class="student-form" id="studentForm">
  <h2>Student Sign Up</h2>
  <form id="studentSignupForm">
    <input type="email" id="studentEmail" placeholder="Enter Gmail" required><br>
    <input type="password" id="studentPassword" placeholder="Enter password" required><br>

    <button type="button" id="sendStudentCode">Send Verification Code</button>
    <span id="resendTimer" style="font-size:0.6rem; display:none;">Resend in <span id="countdown">30</span>s</span><br>

    <input type="text" id="studentCode" placeholder="Enter verification code" style="display:none; width: 40%; margin-right: 10px;">
    <button type="button" id="verifyStudentCode" style="display:none;">Verify Code</button><br>
    <button type="submit" id="createStudentAccount" style="display:none;">Create Account</button>
  </form>
  <p class="message" id="studentMessage"></p>
  <p>Already have an account? <a href="signin.html" style="color:#1DB954;">Sign in here</a>.</p> <!-- Updated path -->
</div>

<!-- Teacher Form -->
<div class="teacher-form" id="teacherForm">
  <h2>Teacher Sign Up</h2>
  <p>Note: Only DepEd accounts can register (e.g., teacher@ed.gov).</p>
  <form id="teacherSignupForm">
    <input type="email" id="teacherEmail" placeholder="Enter DepEd email" required><br>
    <input type="password" id="teacherPassword" placeholder="Enter password" required><br>
    <button type="submit">Create Account</button>
  </form>
  <p class="message" id="teacherMessage"></p>
  <p>Already have an account? <a href="signin.html" style="color:#1DB954;">Sign in here</a>.</p> <!-- Updated path -->
</div>

<script type="module">
import { auth, db } from '../System/Database/firebase.js'; // Updated path
import { createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { setDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

let studentVerificationCode = null;
let studentVerified = false;
let resendCooldown = null;

// === Navigation ===
document.getElementById("homeBtn").addEventListener("click", () => {
  window.location.href = "../index.html"; // Updated path
});

// === UI Functions ===
function showStudentForm() {
  document.getElementById('choiceSection').style.display = 'none';
  document.getElementById('studentForm').style.display = 'block';
  document.getElementById('formBackBtn').style.display = 'block';
  document.getElementById('homeBtn').style.display = 'none';
}

function showTeacherForm() {
  document.getElementById('choiceSection').style.display = 'none';
  document.getElementById('teacherForm').style.display = 'block';
  document.getElementById('formBackBtn').style.display = 'block';
  document.getElementById('homeBtn').style.display = 'none';
}

function backToChoice() {
  document.getElementById('studentForm').style.display = 'none';
  document.getElementById('teacherForm').style.display = 'none';
  document.getElementById('choiceSection').style.display = 'block';
  document.getElementById('formBackBtn').style.display = 'none';
  document.getElementById('homeBtn').style.display = 'block';
  // Reset student form state
  studentVerificationCode = null;
  studentVerified = false;
  document.getElementById('studentSignupForm').reset();
  document.getElementById('studentCode').style.display = 'none';
  document.getElementById('verifyStudentCode').style.display = 'none';
  document.getElementById('createStudentAccount').style.display = 'none';
  document.getElementById('studentMessage').textContent = '';
  if (resendCooldown) clearInterval(resendCooldown);
}

// === Attach Button Events ===
document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("studentBtn").addEventListener("click", showStudentForm);
  document.getElementById("teacherBtn").addEventListener("click", showTeacherForm);
  document.getElementById("formBackBtn").addEventListener("click", backToChoice);
});

// === Send Student Code ===
document.getElementById('sendStudentCode').addEventListener('click', function() {
  const email = document.getElementById('studentEmail').value.trim();
  const password = document.getElementById('studentPassword').value;
  const msg = document.getElementById('studentMessage');
  const sendBtn = document.getElementById('sendStudentCode');
  const timerText = document.getElementById('resendTimer');
  const countdown = document.getElementById('countdown');

  if (!email || !password) {
    msg.style.color = "#ff5252";
    msg.textContent = "‚ùå Please fill in email and password.";
    return;
  }
  if (!email.includes('@gmail.com')) {
    msg.style.color = "#ff5252";
    msg.textContent = "‚ùå Use a Gmail address.";
    return;
  }

  studentVerificationCode = Math.floor(100000 + Math.random() * 900000).toString();
  msg.style.color = "#1DB954";
  msg.textContent = "üì§ Sending verification code...";
  sendBtn.disabled = true;

  fetch('https://script.google.com/macros/s/AKfycbyvjBa_RaZ_UAqFgQZ2anIGNmRM4_SOzHAMp-ImAL7OtICmccpLhQQV8XjM90uAfTwF/exec', { // Replace YOUR_SCRIPT_ID with real ID
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ to: email, code: studentVerificationCode })
  }).then(response => {
    if (!response.ok) throw new Error('Network error');
    msg.textContent = "‚úÖ Code sent! Check Gmail.";
    document.getElementById('studentCode').style.display = 'inline-block';
    document.getElementById('verifyStudentCode').style.display = 'inline-block';
    let timeLeft = 30;
    timerText.style.display = 'inline-block';
    countdown.textContent = timeLeft;
    resendCooldown = setInterval(() => {
      timeLeft--;
      countdown.textContent = timeLeft;
      if (timeLeft <= 0) {
        clearInterval(resendCooldown);
        sendBtn.disabled = false;
        timerText.style.display = 'none';
      }
    }, 1000);
  }).catch(err => {
    console.error("Email send error:", err); // DEBUG
    msg.style.color = "#ff5252";
    msg.textContent = "‚ùå Failed to send email. Check network or script ID.";
    sendBtn.disabled = false;
  });
});

// === Verify Code ===
document.getElementById('verifyStudentCode').addEventListener('click', () => {
  const code = document.getElementById('studentCode').value.trim();
  const msg = document.getElementById('studentMessage');
  if (!code) {
    msg.style.color = "#ff5252";
    msg.textContent = "‚ùå Enter the verification code.";
    return;
  }
  if (code === studentVerificationCode) {
    studentVerified = true;
    msg.style.color = "#1DB954";
    msg.textContent = "‚úÖ Verified! You can now create your account.";
    document.getElementById('verifyStudentCode').style.display = 'none';
    document.getElementById('createStudentAccount').style.display = 'inline-block';
  } else {
    msg.style.color = "#ff5252";
    msg.textContent = "‚ùå Invalid code.";
  }
});

// === Student Create Account ===
document.getElementById('studentSignupForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const email = document.getElementById('studentEmail').value.trim();
  const password = document.getElementById('studentPassword').value;
  const msg = document.getElementById('studentMessage');
  if (!studentVerified) {
    msg.textContent = "‚ùå Verify your email first.";
    return;
  }
  try {
    const userCred = await createUserWithEmailAndPassword(auth, email, password);
    await setDoc(doc(db, "users", userCred.user.uid), {
      email,
      role: "student",
      level: 1,
      xp: 0
    });
    msg.style.color = "#1DB954";
    msg.textContent = "‚úÖ Account created! Redirecting...";
    setTimeout(() => window.location.href = 'signin.html', 1200); // Updated path
  } catch (err) {
    console.error("Account creation error:", err); // DEBUG
    msg.style.color = "#ff5252";
    msg.textContent = `‚ùå ${err.message}`;
  }
});

// === Teacher Create Account ===
document.getElementById('teacherSignupForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const email = document.getElementById('teacherEmail').value.trim();
  const password = document.getElementById('teacherPassword').value;
  const msg = document.getElementById('teacherMessage');
  if (!email || !password) {
    msg.style.color = "#ff5252";
    msg.textContent = "‚ùå Please fill in all fields.";
    return;
  }
  if (!email.includes('@ed.gov') && !email.includes('@deped.gov.ph')) {
    msg.style.color = "#ff5252";
    msg.textContent = "‚ùå Invalid DepEd email.";
    return;
  }
  try {
    const userCred = await createUserWithEmailAndPassword(auth, email, password);
    await setDoc(doc(db, "users", userCred.user.uid), {
      email,
      role: "teacher",
      level: 1,
      xp: 0
    });
    msg.style.color = "#1DB954";
    msg.textContent = "‚úÖ Teacher account created! Redirecting...";
    setTimeout(() => window.location.href = 'signin.html', 1200); // Updated path
  } catch (err) {
    console.error("Account creation error:", err); // DEBUG
    msg.style.color = "#ff5252";
    msg.textContent = `‚ùå ${err.message}`;
  }
});
</script>
</body>
</html>
