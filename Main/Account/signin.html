<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sign In | MindCraft</title>

<!-- ==============================
 üé® Fonts & Style
============================== -->
<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@600;700;800&display=swap" rel="stylesheet">

<style>
/* ==============================
 üîß Global Reset
============================== */
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

/* ==============================
 üåà Body Styling
============================== */
body {
  font-family: 'Baloo 2', cursive;
  min-height: 100vh;
  background: linear-gradient(to bottom, #8fe9ff, #c8f7b0);
  display: flex;
  justify-content: center;
  align-items: center;
  position: relative;
}

/* ‚ú® Background Glow Stars */
body::before {
  content: "";
  position: absolute;
  inset: 0;
  background:
    radial-gradient(circle at 20% 30%, #fff 2px, transparent 3px),
    radial-gradient(circle at 70% 20%, #fff 2px, transparent 3px),
    radial-gradient(circle at 40% 80%, #fff 2px, transparent 3px);
  opacity: 0.25;
  pointer-events: none;
}

/* ==============================
 üè† Home & Back Buttons
============================== */
.home-wrap, 
.back-wrap {
  position: absolute;
  top: 24px;
  left: 24px;
  z-index: 10;
}

.home-btn, 
.back-btn {
  background: #ffae42;
  border: none;
  padding: 10px 18px;
  border-radius: 18px;
  font-size: 15px;
  font-weight: 700;
  color: #5a3a1a;
  cursor: pointer;
  box-shadow: 0 4px 0 #d8942f;
  transition: transform 0.2s ease;
}

.home-btn:hover, 
.back-btn:hover {
  transform: translateY(-1px);
}

.home-btn:active, 
.back-btn:active {
  transform: translateY(2px);
}

/* ==============================
 üì¶ Main Panel Container
============================== */
.panel {
  background: white;
  width: 400px;
  padding: 36px;
  border-radius: 26px;
  text-align: center;
  box-shadow: 0 14px 28px rgba(0, 0, 0, 0.2);
  position: relative;
  z-index: 1;
}

/* ==============================
 üß≠ Typography
============================== */
.title {
  font-size: 38px;
  font-weight: 800;
  color: #5a3a1a;
  margin-bottom: 6px;
}

.subtitle {
  font-size: 17px;
  color: #6d4c41;
  margin-bottom: 24px;
}

/* ==============================
 ‚úèÔ∏è Input Styling
============================== */
input {
  width: 100%;
  padding: 13px;
  border-radius: 14px;
  border: none;
  background: #f3f3f3;
  font-size: 15px;
  margin-bottom: 12px;
}

/* ==============================
 üîò Button Styling
============================== */
button {
  width: 100%;
  background: #b8783d;
  color: white;
  border: none;
  border-radius: 18px;
  padding: 14px;
  font-size: 17px;
  font-weight: 700;
  cursor: pointer;
  box-shadow: 0 5px 0 #6b3e1a;
  transition: transform 0.15s ease;
}

button:hover {
  transform: translateY(-1px);
}

button:active {
  transform: translateY(3px);
}

.role-btn {
  margin-bottom: 12px;
}

/* ==============================
 üîó Auth Links
============================== */
.auth-link {
  margin-top: 14px;
  font-size: 14px;
}

.auth-link a {
  color: #1db954;
  font-weight: 700;
  text-decoration: none;
}

/* ==============================
 ‚ö†Ô∏è Error & Message Text
============================== */
.message {
  margin-top: 10px;
  font-weight: 700;
  color: #c62828;
  font-size: 14px;
}

/* ==============================
 üçû Toast Notification
============================== */
.toast {
  position: fixed;
  bottom: 24px;
  right: 24px;
  background: #1db954;
  color: white;
  padding: 14px 18px;
  border-radius: 14px;
  font-weight: 700;
  opacity: 0;
  transform: translateY(20px);
  transition: 0.4s;
  z-index: 9999;
}

.toast.show {
  opacity: 1;
  transform: translateY(0);
}

.toast.error {
  background: #c62828;
}

/* ==============================
 üì± Responsive Adjustments
============================== */
.student-form, 
.teacher-form {
  display: none;
}

.inner-btn {
  margin-bottom: 12px;
}
</style>
</head>

<body>

<!-- ==============================
 üè† Home Button
============================== -->
<div class="home-wrap">
  <button id="homeBtn" class="home-btn">Home</button>
</div>

<!-- ==============================
 ‚¨ÖÔ∏è Back Button
============================== -->
<div class="back-wrap" style="display:none;">
  <button id="backBtn" class="back-btn">Back</button>
</div>

<!-- ==============================
 üß© Role Selection
============================== -->
<div class="panel" id="choiceSection">
  <div class="title">MindCraft</div>
  <div class="subtitle">Choose your role to sign in</div>

  <button class="role-btn" id="studentBtn">Student</button>
  <button class="role-btn" id="teacherBtn">Teacher</button>

  <div class="auth-link">
    Don‚Äôt have an account? <a href="signup.html">Sign up</a>
  </div>
</div>

<!-- ==============================
 üéì Student Login Section
============================== -->
<div class="panel student-form" id="studentForm">
  <div class="title">Student Login</div>

  <form id="studentSigninForm">
    <input type="email" id="studentEmail" placeholder="Gmail address" required>
    <input type="password" id="studentPassword" placeholder="Password" required>
    <button type="submit">Login</button>
  </form>

  <p class="message" id="studentMessage"></p>
  <button id="studentForgot" class="inner-btn">Forgot Password?</button>
</div>

<!-- ==============================
 üßë‚Äçüè´ Teacher Login (Disabled)
============================== -->
<div class="panel teacher-form" id="teacherForm">
  <div class="title">Teacher Login</div>
  <div class="subtitle">DepEd email only</div>

  <form id="teacherSigninForm">
    <input type="email" id="teacherEmail" placeholder="DepEd email" required>
    <input type="password" id="teacherPassword" placeholder="Password" required>
    <button type="submit">Login</button>
  </form>

  <p class="message" id="teacherMessage"></p>
  <button id="teacherForgot" class="inner-btn">Forgot Password?</button>
  <button id="resendTeacher" class="inner-btn" style="background:#ff69b4;">Resend Verification</button>
</div>

<!-- ==============================
 üçû Toast Element
============================== -->
<div id="toast" class="toast"></div>

<!-- ==============================
 ‚öôÔ∏è JavaScript Section
============================== -->
<script type="module">
/* Firebase Imports */
import { auth, db } from '../System/Database/firebase.js';
import { signInWithEmailAndPassword, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getDoc, setDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* ==============================
 üîß DOM Elements
============================== */
const studentBtn = document.getElementById("studentBtn");
const teacherBtn = document.getElementById("teacherBtn");
const choiceSection = document.getElementById("choiceSection");
const studentForm = document.getElementById("studentForm");
const teacherForm = document.getElementById("teacherForm");
const homeBtn = document.getElementById("homeBtn");
const backWrap = document.querySelector(".back-wrap");
const backBtn = document.getElementById("backBtn");
const studentMessage = document.getElementById("studentMessage");
const teacherMessage = document.getElementById("teacherMessage");

/* ==============================
 üçû Toast Message Function
============================== */
function showToast(msg, isError = false) {
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.className = "toast show" + (isError ? " error" : "");
  setTimeout(() => t.className = "toast", 3000);
}

/* ==============================
 üßë‚Äçüéì Show Student Login
============================== */
studentBtn.addEventListener("click", () => {
  choiceSection.style.display = "none";
  studentForm.style.display = "block";
  homeBtn.style.display = "none";
  backWrap.style.display = "block";
});

/* ==============================
 üö´ Disable Teacher Login (Coming Soon)
============================== */
teacherBtn.addEventListener("click", () => {
  showToast("Teacher login is not available yet.", true);

  // Uncomment below once Teacher feature is active:
  // choiceSection.style.display = "none";
  // teacherForm.style.display = "block";
  // homeBtn.style.display = "none";
  // backWrap.style.display = "block";
});

/* ==============================
 ‚¨ÖÔ∏è Back Button Logic
============================== */
backBtn.addEventListener("click", () => {
  studentForm.style.display = "none";
  teacherForm.style.display = "none";
  choiceSection.style.display = "block";
  homeBtn.style.display = "block";
  backWrap.style.display = "none";

  studentSigninForm.reset();
  teacherSigninForm.reset();
  studentMessage.textContent = "";
  teacherMessage.textContent = "";
});

/* ==============================
 üè† Home Button Logic
============================== */
homeBtn.addEventListener("click", () => location.href='../../index.html');

/* ==============================
 üßÆ Default Student Data Fields
============================== */
const defaultStudentFields = {
  level: 1,
  xp: 0,
  xpMax: 100,
  totalXP: 0,
  completedLessons: [],
  completedQuizzes: []
};

/* ==============================
 üß† Student Sign-In Logic
============================== */
studentSigninForm.addEventListener("submit", async e => {
  e.preventDefault();
  const email = studentEmail.value.trim();
  const password = studentPassword.value;
  studentMessage.textContent = "";

  try {
    const userCred = await signInWithEmailAndPassword(auth, email, password);
    const user = userCred.user;

    // üîç Verify email before allowing login
    if (!user.emailVerified) {
      studentMessage.textContent = "Please verify your email before signing in.";
      await signOut(auth);
      return;
    }

    // üîó Reference user data in Firestore
    const ref = doc(db, "users", user.uid);
    const snap = await getDoc(ref);

    // üß© Recreate data if missing
    if (!snap.exists()) {
      await setDoc(ref, {
        name: user.displayName || user.email.split("@")[0],
        email: user.email,
        role: "student",
        verified: user.emailVerified,
        ...defaultStudentFields,
        createdAt: new Date()
      });
      console.log("‚úÖ Firestore record recreated for missing student.");
    } else if (snap.data().role !== "student") {
      studentMessage.textContent = "This account is not a student.";
      await signOut(auth);
      return;
    }

    const data = (await getDoc(ref)).data();
    localStorage.setItem("currentUser", user.uid);
    localStorage.setItem("cachedName", data.name || "Student");
    localStorage.setItem("currentRole", "student");

    showToast("Login successful");
    setTimeout(() => location.href = "../Startup/StartupS.html", 1200);

  } catch (err) {
    console.error(err);
    showToast(err.message, true);
  }
});

/* ==============================
 üîë Forgot Password (Student)
============================== */
studentForgot.addEventListener("click", async () => {
  const email = studentEmail.value.trim();
  if (!email) {
    showToast("Enter Gmail first.", true);
    return;
  }
  try {
    await sendPasswordResetEmail(auth, email);
    showToast("Password reset email sent.");
  } catch (err) {
    showToast(err.message, true);
  }
});

/* ==============================
 üßë‚Äçüè´ Teacher Login (Commented for Future Use)
============================== */
// teacherSigninForm.addEventListener("submit", async e => {
//   e.preventDefault();
//   const email = teacherEmail.value.trim();
//   const password = teacherPassword.value;
//   teacherMessage.textContent = "";

//   try {
//     const userCred = await signInWithEmailAndPassword(auth, email, password);
//     const user = userCred.user;

//     if (!user.emailVerified) {
//       teacherMessage.textContent = "Please verify your email before signing in.";
//       await signOut(auth);
//       return;
//     }

//     const ref = doc(db, "users", user.uid);
//     const snap = await getDoc(ref);

//     if (!snap.exists() || snap.data().role !== "teacher") {
//       teacherMessage.textContent = "This account is not a teacher.";
//       await signOut(auth);
//       return;
//     }

//     localStorage.setItem("currentUser", user.uid);
//     localStorage.setItem("cachedName", snap.data().name || "Teacher");
//     localStorage.setItem("currentRole", "teacher");

//     showToast("Login successful");
//     setTimeout(() => location.href = "../Startup/StartupT.html", 1200);

//   } catch (err) {
//     showToast(err.message, true);
//   }
// });
</script>
</body>
</html>
