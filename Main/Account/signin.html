<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sign In | MindCraft</title>

<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@600;700;800&display=swap" rel="stylesheet">

<style>
*{box-sizing:border-box;margin:0;padding:0}

body{
  font-family:'Baloo 2', cursive;
  min-height:100vh;
  background:linear-gradient(to bottom,#8fe9ff,#c8f7b0);
  display:flex;
  justify-content:center;
  align-items:center;
  position:relative;
}

body::before{
  content:"";
  position:absolute;
  inset:0;
  background:
    radial-gradient(circle at 20% 30%, #fff 2px, transparent 3px),
    radial-gradient(circle at 70% 20%, #fff 2px, transparent 3px),
    radial-gradient(circle at 40% 80%, #fff 2px, transparent 3px);
  opacity:.25;
}

/* Home button */
.home-wrap{
  position:absolute;
  top:24px;
  left:24px;
}
.home-btn{
  background:#ffae42;
  border:none;
  padding:10px 18px;
  border-radius:18px;
  font-size:15px;
  font-weight:700;
  color:#5a3a1a;
  cursor:pointer;
  box-shadow:0 4px 0 #d8942f;
}
.home-btn:hover{transform:translateY(-1px)}
.home-btn:active{transform:translateY(2px)}

/* Card */
.panel{
  background:white;
  width:400px;
  padding:36px;
  border-radius:26px;
  text-align:center;
  box-shadow:0 14px 28px rgba(0,0,0,.2);
}

/* Text */
.title{
  font-size:38px;
  font-weight:800;
  color:#5a3a1a;
  margin-bottom:6px;
}
.subtitle{
  font-size:17px;
  color:#6d4c41;
  margin-bottom:24px;
}

/* Inputs */
input{
  width:100%;
  padding:13px;
  border-radius:14px;
  border:none;
  background:#f3f3f3;
  font-size:15px;
  margin-bottom:12px;
}

/* Buttons */
button{
  width:100%;
  background:#b8783d;
  color:white;
  border:none;
  border-radius:18px;
  padding:14px;
  font-size:17px;
  font-weight:700;
  cursor:pointer;
  box-shadow:0 5px 0 #6b3e1a;
  transition:.2s;
}
button:hover{transform:translateY(-1px)}
button:active{transform:translateY(3px)}

.role-btn{margin-bottom:12px}
.back{
  margin-top:14px;
  background:#bdbdbd;
  box-shadow:0 5px 0 #8d8d8d;
}

/* Links */
.auth-link{
  margin-top:14px;
  font-size:14px;
}
.auth-link a{
  color:#1db954;
  font-weight:700;
  text-decoration:none;
}

/* Message */
.message{
  margin-top:10px;
  font-weight:700;
  color:#c62828;
  font-size:14px;
}

/* Toast */
.toast{
  position:fixed;
  bottom:24px;
  right:24px;
  background:#1db954;
  color:white;
  padding:14px 18px;
  border-radius:14px;
  font-weight:700;
  opacity:0;
  transform:translateY(20px);
  transition:.4s;
}
.toast.show{opacity:1;transform:translateY(0)}
.toast.error{background:#c62828}

/* Hide sections */
.student-form,.teacher-form{display:none}
</style>
</head>

<body>

<!-- HOME BUTTON -->
<div class="home-wrap">
  <button class="home-btn" onclick="location.href='../../index.html'">Home</button>
</div>

<!-- ROLE CHOICE -->
<div class="panel" id="choiceSection">
  <div class="title">MindCraft</div>
  <div class="subtitle">Choose your role to sign in</div>

  <button class="role-btn" id="studentBtn">Student</button>
  <button class="role-btn" id="teacherBtn">Teacher</button>

  <div class="auth-link">
    Donâ€™t have an account? <a href="signup.html">Sign up</a>
  </div>
</div>

<!-- STUDENT SIGN IN -->
<div class="panel student-form" id="studentForm">
  <div class="title">Student Login</div>

  <form id="studentSigninForm">
    <input type="email" id="studentEmail" placeholder="Gmail address" required>
    <input type="password" id="studentPassword" placeholder="Password" required>
    <button type="submit">Login</button>
  </form>

  <p class="message" id="studentMessage"></p>
  <button id="resendStudent" class="back" style="background:#ff69b4;">Resend Verification</button>
  <button class="back" onclick="backToChoice()">Back</button>
</div>

<!-- TEACHER SIGN IN -->
<div class="panel teacher-form" id="teacherForm">
  <div class="title">Teacher Login</div>
  <div class="subtitle">DepEd email only</div>

  <form id="teacherSigninForm">
    <input type="email" id="teacherEmail" placeholder="DepEd email" required>
    <input type="password" id="teacherPassword" placeholder="Password" required>
    <button type="submit">Login</button>
  </form>

  <p class="message" id="teacherMessage"></p>
  <button id="resendTeacher" class="back" style="background:#ff69b4;">Resend Verification</button>
  <button class="back" onclick="backToChoice()">Back</button>
</div>

<div id="toast" class="toast"></div>

<script type="module">
import { auth, db } from '../System/Database/firebase.js';
import {
  signInWithEmailAndPassword,
  signOut,
  sendEmailVerification,
  sendPasswordResetEmail
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getDoc, setDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* UI */
studentBtn.onclick=()=>{
  choiceSection.style.display="none";
  studentForm.style.display="block";
}
teacherBtn.onclick=()=>{
  choiceSection.style.display="none";
  teacherForm.style.display="block";
}
function backToChoice(){
  studentForm.style.display="none";
  teacherForm.style.display="none";
  choiceSection.style.display="block";
}

/* Toast */
function showToast(msg,isError=false){
  const t=document.getElementById("toast");
  t.textContent=msg;
  t.className="toast show"+(isError?" error":"");
  setTimeout(()=>t.className="toast",3000);
}

/* Default Student Fields */
const defaultStudentFields = {
  level: 1, xp: 0, xpMax: 100, totalXP: 0,
  completedLessons: [], completedQuizzes: []
};

/* ==== STUDENT SIGN IN ==== */
studentSigninForm.addEventListener("submit",async e=>{
  e.preventDefault();
  const email=studentEmail.value.trim();
  const password=studentPassword.value;
  const msg=studentMessage;

  msg.textContent="";
  try{
    const userCred=await signInWithEmailAndPassword(auth,email,password);
    const user=userCred.user;

    if(!user.emailVerified){
      msg.textContent="Please verify your email before signing in.";
      await signOut(auth);
      return;
    }

    const ref=doc(db,"users",user.uid);
    const snap=await getDoc(ref);
    if(!snap.exists()||snap.data().role!=="student"){
      msg.textContent="This account is not a student.";
      await signOut(auth);
      return;
    }

    let data=snap.data();
    for(const key in defaultStudentFields){
      if(!(key in data)) data[key]=defaultStudentFields[key];
    }
    await setDoc(ref,data,{merge:true});

    localStorage.setItem("currentUser",user.uid);
    localStorage.setItem("cachedName",data.name||"Student");
    localStorage.setItem("currentRole","student");

    showToast("Login successful");
    setTimeout(()=>location.href="../Startup/StartupS.html",1200);

  }catch(err){
    showToast(err.message,true);
  }
});

/* ==== STUDENT FORGOT PASSWORD ==== */
const studentForgot=document.createElement("button");
studentForgot.textContent="Forgot Password?";
studentForgot.className="back";
studentForgot.style.background="#ffae42";
studentForgot.onclick=async()=>{
  const email=studentEmail.value.trim();
  if(!email){showToast("Enter your Gmail first.",true);return;}
  try{
    await sendPasswordResetEmail(auth,email);
    showToast("Password reset email sent.");
  }catch(err){showToast(err.message,true);}
};
studentForm.appendChild(studentForgot);

/* ==== STUDENT RESEND VERIFICATION ==== */
resendStudent.addEventListener("click",async()=>{
  const email=studentEmail.value.trim();
  const password=studentPassword.value;
  try{
    const userCred=await signInWithEmailAndPassword(auth,email,password);
    const user=userCred.user;
    await sendEmailVerification(user);
    showToast("Verification email sent again.");
    await signOut(auth);
  }catch(err){showToast(err.message,true);}
});

/* ==== TEACHER SIGN IN ==== */
teacherSigninForm.addEventListener("submit",async e=>{
  e.preventDefault();
  const email=teacherEmail.value.trim();
  const password=teacherPassword.value;
  const msg=teacherMessage;

  msg.textContent="";
  try{
    const userCred=await signInWithEmailAndPassword(auth,email,password);
    const user=userCred.user;

    if(!user.emailVerified){
      msg.textContent="Please verify your email before signing in.";
      await signOut(auth);
      return;
    }

    const ref=doc(db,"users",user.uid);
    const snap=await getDoc(ref);
    if(!snap.exists()||snap.data().role!=="teacher"){
      msg.textContent="This account is not a teacher.";
      await signOut(auth);
      return;
    }

    localStorage.setItem("currentUser",user.uid);
    localStorage.setItem("cachedName",snap.data().name||"Teacher");
    localStorage.setItem("currentRole","teacher");

    showToast("Login successful");
    setTimeout(()=>location.href="../Startup/StartupT.html",1200);

  }catch(err){
    showToast(err.message,true);
  }
});

/* ==== TEACHER FORGOT PASSWORD ==== */
const teacherForgot=document.createElement("button");
teacherForgot.textContent="Forgot Password?";
teacherForgot.className="back";
teacherForgot.style.background="#ffae42";
teacherForgot.onclick=async()=>{
  const email=teacherEmail.value.trim();
  if(!email){showToast("Enter your DepEd email first.",true);return;}
  try{
    await sendPasswordResetEmail(auth,email);
    showToast("Password reset email sent.");
  }catch(err){showToast(err.message,true);}
};
teacherForm.appendChild(teacherForgot);

/* ==== TEACHER RESEND VERIFICATION ==== */
resendTeacher.addEventListener("click",async()=>{
  const email=teacherEmail.value.trim();
  const password=teacherPassword.value;
  try{
    const userCred=await signInWithEmailAndPassword(auth,email,password);
    const user=userCred.user;
    await sendEmailVerification(user);
    showToast("Verification email sent again.");
    await signOut(auth);
  }catch(err){showToast(err.message,true);}
});
</script>

</body>
</html>
