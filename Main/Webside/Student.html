<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MindCraft | Code Lessons</title>

<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<!--<link rel="stylesheet" href="../Design/Position.css">-->
<link rel="stylesheet" href="../Design/level.css">
<!--<link rel="stylesheet" href="../Design/global_size-FIX.css">-->

<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
html, body { width: 100%; height: 100%; }

/* ===== BODY / BACKGROUND ===== */
body {
font-family: 'Press Start 2P', cursive;
background: linear-gradient(180deg, #a0c4ff 0%, #d4edc4 100%);
color: #3b2a15;
min-height: 100vh;
display: flex;
flex-direction: column;
overflow-x: hidden;
padding: 20px;
font-size: 10px;
}

/* ===== HEADER ===== */
header {
width: 100vw;
margin-left: -20px;
margin-right: -20px;
margin-top: -20px;
display: flex;
flex-direction: column;
justify-content: flex-start;
align-items: center;
padding: 15px 0;
background: #7a4f2f;
border-bottom: 4px solid #5c3a1a;
box-shadow: inset -3px -3px 0 rgba(0,0,0,0.3), 0 4px 0 #3b2a15;
}

header h1 {
color: #d9b16c;
font-size: 0.8rem;
margin-bottom: 8px;
text-shadow: 2px 2px #3b2a15;
}

.xp-group {
display: flex;
justify-content: space-between;
align-items: center;
width: 100%;
max-width: 400px;
margin-bottom: 10px;
padding: 0 15px;
}

.xp-status {
display: flex;
align-items: center;
gap: 8px;
color: #d9b16c;
text-shadow: 1px 1px #3b2a15;
}

.xp-bar-container {
display: flex;
align-items: center;
gap: 6px;
}

#xpBar {
width: 100px;
height: 12px;
accent-color: #d9b16c;
border: 2px solid #a97c4b;
border-radius: 2px;
background: #5c3a1a;
}

#xpValue {
display: inline-block;
min-width: 60px;
text-align: right;
font-size: 0.5rem;
color: #d9b16c;
font-weight: bold;
text-shadow: 1px 1px #3b2a15;
}

.level-display {
font-size: 0.5rem;
color: #d9b16c;
text-shadow: 1px 1px #3b2a15;
}

.user-actions {
display: flex;
gap: 8px;
margin-top: 8px;
justify-content: center;
flex-wrap: wrap;
width: 100%;
}

/* ===== BUTTONS ===== */
button {
font-family: 'Press Start 2P', cursive;
background: #d9b16c;
color: #3b2a15;
border: 3px solid #a97c4b;
padding: 8px 12px;
border-radius: 6px;
cursor: pointer;
font-size: 0.45rem;
text-transform: uppercase;
letter-spacing: 0.5px;
box-shadow: 0 4px 0 #a97c4b, 0 5px 0 #3b2a15;
transition: all 0.1s ease;
user-select: none;
}

button:hover {
transform: translateY(-2px);
background: #e5c890;
box-shadow: 0 6px 0 #a97c4b, 0 7px 0 #3b2a15;
}

button:active {
transform: translateY(2px);
background: #cfa356;
box-shadow: 0 2px 0 #a97c4b, 0 3px 0 #3b2a15;
}

button:disabled {
opacity: 0.5;
cursor: not-allowed;
}

/* ===== RANK DISPLAY ===== */
#rankDisplay {
background: #e3d5a2;
border: 3px solid #a97c4b;
color: #3b2a15;
padding: 8px 12px;
border-radius: 6px;
font-size: 0.45rem;
text-align: center;
box-shadow: 0 4px 0 #a97c4b;
}

#rankDisplay.rank-top {
animation: rankGlow 1.5s infinite alternate;
}

@keyframes rankGlow {
0% { box-shadow: 0 4px 0 #a97c4b, 0 0 8px #ffd700; }
100% { box-shadow: 0 4px 0 #a97c4b, 0 0 15px #ffd700; }
}

/* ===== MAIN CONTENT ===== */
main {
text-align: center;
padding: 30px 20px;
flex-grow: 1;
display: flex;
flex-direction: column;
align-items: center;
}

main h1 {
color: #3b2a15;
font-size: 0.8rem;
margin-bottom: 20px;
text-shadow: 2px 2px rgba(255,255,255,0.5);
letter-spacing: 2px;
}

/* ===== LESSON CONTAINER ===== */
.lesson-container {
position: relative;
text-align: center;
padding: 25px 20px;
background: #d4e0c7;
border: 4px solid #5c915c;
border-radius: 10px;
max-width: 650px;
margin: 20px auto;
box-shadow: inset -4px -4px 0 rgba(0,0,0,0.15), 0 8px 0 #5c915c;
transition: all 0.3s ease;
}

/* ===== LANGUAGE VIEW ===== */
#languageView {
display: flex;
justify-content: center;
align-items: center;
position: relative;
min-height: 220px;
transition: all 0.4s ease;
}

/* ===== LANGUAGE CARDS ===== */
.language-card {
display: none;
flex-direction: column;
align-items: center;
justify-content: center;
text-align: center;
background: #c3d8b5;
border: 3px solid #4a7d4a;
border-radius: 10px;
padding: 25px 20px;
width: 220px;
height: 200px;
box-shadow: 0 4px 0 #4a7d4a, inset -2px -2px 0 rgba(0,0,0,0.1);
opacity: 0;
transform: translateX(40px) scale(0.9);
transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
cursor: pointer;
position: absolute;
}

.language-card img {
width: 80px;
height: 80px;
object-fit: contain;
margin-bottom: 10px;
filter: drop-shadow(2px 2px 0 rgba(0,0,0,0.2));
}

.language-card p {
font-size: 0.6rem;
color: #3e763e;
text-shadow: 1px 1px rgba(255,255,255,0.5);
margin: 0;
}

.language-card.active {
display: flex;
opacity: 1;
transform: translateX(0) scale(1);
border-color: #2d5a2d;
box-shadow: 0 6px 0 #4a7d4a, 0 8px 0 #2d5a2d, inset -2px -2px 0 rgba(0,0,0,0.1);
z-index: 10;
animation: cardPop 0.3s ease;
}

@keyframes cardPop {
0% { transform: translateX(0) scale(0.95); }
50% { transform: translateX(0) scale(1.05); }
100% { transform: translateX(0) scale(1); }
}

/* ===== NAV ARROWS ===== */
.nav-arrow {
position: absolute;
top: 50%;
transform: translateY(-50%);
width: 44px;
height: 44px;
border-radius: 6px;
background: #d9b16c;
border: 3px solid #a97c4b;
color: #3b2a15;
display: flex;
justify-content: center;
align-items: center;
font-size: 0.6rem;
font-weight: bold;
cursor: pointer;
box-shadow: 0 4px 0 #a97c4b, 0 5px 0 #3b2a15;
transition: all 0.1s ease;
z-index: 50;
user-select: none;
}

.nav-arrow:hover {
transform: translateY(-50%) translateY(-2px);
background: #e5c890;
box-shadow: 0 6px 0 #a97c4b, 0 7px 0 #3b2a15;
}

.nav-arrow:active {
transform: translateY(-50%) translateY(2px);
background: #cfa356;
box-shadow: 0 2px 0 #a97c4b, 0 3px 0 #3b2a15;
}

.nav-arrow.left { 
left: -60px;
}

.nav-arrow.right { 
right: -60px;
}

/* ===== PANEL BACKDROP ===== */
#panelBackdrop {
position: fixed;
top: 0;
left: 0;
width: 100vw;
height: 100vh;
background: rgba(0, 0, 0, 0.5);
backdrop-filter: blur(3px);
z-index: 998;
display: none;
}

.blur-active {
overflow: hidden;
}

/* ===== LANGUAGE PANEL ===== */
.language-panel {
position: fixed;
top: 50%;
left: 50%;
transform: translate(-50%, -50%);
background: #d4e0c7;
border: 4px solid #5c915c;
border-radius: 12px;
padding: 30px;
width: 90%;
max-width: 520px;
box-shadow: 0 8px 0 #5c915c, 0 10px 20px rgba(0,0,0,0.3), inset -3px -3px 0 rgba(0,0,0,0.1);
z-index: 999;
display: none;
flex-direction: column;
align-items: center;
justify-content: center;
animation: panelSlideIn 0.3s ease;
}

@keyframes panelSlideIn {
0% { opacity: 0; transform: translate(-50%, -45%) scale(0.9); }
100% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
}

.language-panel .panel-title {
display: flex;
flex-direction: column;
align-items: center;
gap: 12px;
margin-bottom: 20px;
}

.language-panel .panel-title img {
width: 70px;
height: 70px;
object-fit: contain;
filter: drop-shadow(2px 2px 0 rgba(0,0,0,0.2));
}

.language-panel .panel-title .titleText {
font-size: 0.65rem;
color: #3e763e;
text-shadow: 1px 1px rgba(255,255,255,0.5);
}

.language-panel .panel-content {
display: flex;
flex-direction: column;
gap: 15px;
width: 100%;
margin-bottom: 15px;
}

/* ===== DROPDOWNS ===== */
.lesson-dropdown,
.quiz-dropdown {
position: relative;
display: inline-block;
width: 100%;
}

.lesson-dropdown button,
.quiz-dropdown button {
width: 100%;
margin-bottom: 5px;
}

.lesson-list,
.quiz-list {
display: none;
flex-direction: column;
gap: 6px;
background: #c3d8b5;
border: 3px solid #5c915c;
border-top: none;
border-radius: 0 0 8px 8px;
padding: 10px;
margin-top: -5px;
max-height: 250px;
overflow-y: auto;
}

.lesson-list button,
.quiz-list button {
background: #d4e0c7;
border: 2px solid #4a7d4a;
color: #3e763e;
padding: 8px 10px;
font-size: 0.4rem;
margin: 0;
box-shadow: none;
width: 100%;
text-align: center;
}

.lesson-list button:hover,
.quiz-list button:hover {
background: #c3d8b5;
border-color: #2d5a2d;
}

.lesson-list button:active,
.quiz-list button:active {
background: #b5cca7;
}

/* ===== BACK BUTTON ===== */
.language-panel .panel-back,
.back-btn {
width: 100%;
background: #d9b16c;
border: 3px solid #a97c4b;
color: #3b2a15;
padding: 10px;
font-size: 0.45rem;
margin-top: 10px;
}

.language-panel .panel-back:hover,
.back-btn:hover {
background: #e5c890;
}

/* ===== FOOTER ===== */
footer {
margin-top: auto;
margin-left: -20px;
margin-right: -20px;
margin-bottom: -20px;
background: #7a4f2f;
border-top: 4px solid #5c3a1a;
color: #d9b16c;
text-align: center;
padding: 12px 20px;
font-size: 0.5rem;
box-shadow: inset -2px -2px 0 rgba(0,0,0,0.3), 0 2px 0 #3b2a15;
text-shadow: 1px 1px #3b2a15;
}

/* ===== WELCOME OVERLAY ===== */
#welcomeOverlay {
position: fixed;
top: 0;
left: 0;
width: 100vw;
height: 100vh;
display: none;
justify-content: center;
align-items: center;
background: rgba(0, 0, 0, 0.8);
color: #d9b16c;
font-family: 'Press Start 2P', cursive;
font-size: 0.65rem;
z-index: 2000;
text-align: center;
flex-direction: column;
animation: welcomeFadeIn 0.5s ease forwards;
}

#welcomeOverlay p {
margin: 0;
padding: 20px 30px;
background: #d4e0c7;
border: 4px solid #5c915c;
border-radius: 10px;
box-shadow: 0 8px 0 #5c915c;
color: #3e763e;
text-shadow: 1px 1px rgba(255,255,255,0.5);
animation: textFadeIn 0.8s ease forwards 0.2s;
opacity: 0;
}

@keyframes welcomeFadeIn {
from { opacity: 0; }
to { opacity: 1; }
}

@keyframes textFadeIn {
from { opacity: 0; transform: translateY(-20px); }
to { opacity: 1; transform: translateY(0); }
}

@keyframes welcomeFadeOut {
from { opacity: 1; }
to { opacity: 0; }
}

#welcomeOverlay.fade-out {
animation: welcomeFadeOut 0.6s ease forwards;
}

/* ===== RESPONSIVE ===== */
@media (max-width: 700px) {
.nav-arrow {
width: 40px;
height: 40px;
font-size: 0.5rem;
}
.nav-arrow.left { left: -57px; }
.nav-arrow.right { right: -57px; }
5

@media (max-width: 500px) {
body { padding: 15px; }
header { margin-left: -15px; margin-right: -15px; margin-top: -15px; }
footer { margin-left: -15px; margin-right: -15px; margin-bottom: -15px; }
.nav-arrow { width: 36px; height: 36px; font-size: 0.4rem; }
.nav-arrow.left { left: -55px; }
.nav-arrow.right { right: -55px; }
.language-card { width: 200px; height: 180px; padding: 20px 15px; }
.language-card img { width: 70px; height: 70px; }
.language-panel { padding: 20px; max-width: 90vw; }
}

@media (max-width: 380px) {
.nav-arrow { width: 32px; height: 32px; font-size: 0.35rem; }
.nav-arrow.left { left: -48px; }
.nav-arrow.right { right: -48px; }
.language-card { width: 180px; }
main h1 { font-size: 0.65rem; }
button { padding: 6px 10px; font-size: 0.4rem; }
}
</style>
</head>
<body>

<!-- ‚úÖ Welcome Popup -->
<div id="welcomeOverlay" style="display:none;">
<p>üéâ Welcome, <span id="studentName">Student</span>!</p>
</div>

<header>
<div class="xp-group">
<div class="xp-status">
<span>XP:</span>
<div class="xp-bar-container">
<progress id="xpBar" value="0" max="100"></progress>
<span id="xpValue">0</span>
</div>
</div>
<div class="level-display">
Level <span id="levelValue">1</span>
</div>
</div>

<div class="user-actions">
<button onclick="location.href='../Account/account.html'">üë§ Account</button>
<button id="leaderboardBtn">üèÜ Leaderboard</button>
<button id="rankDisplay">Rank: #--</button>
<button onclick="location.href='../Settings/setting.html'">‚öôÔ∏è Settings</button>
</div>
</header>

<main>
<h1>CHOOSE A CODE LANGUAGE</h1>

<div class="lesson-container">
<button class="nav-arrow left" id="prevLang">‚¨Ö</button>
<button class="nav-arrow right" id="nextLang">‚û°</button>

<div id="languageView">
<div class="language-card active" data-lang="HTML">
<img src="../Assets/Icons/html.png" alt="HTML">
<p>HTML</p>
</div>

<div class="language-card" data-lang="CSS">
<img src="../Assets/Icons/css.png" alt="CSS">
<p>CSS</p>
</div>

<div class="language-card" data-lang="JS">
<img src="../Assets/Icons/js.png" alt="JavaScript">
<p>JavaScript</p>
</div>
</div>
</div>

<!-- ‚úÖ Hidden selects for internal data -->
<select id="htmlLessons" style="display:none;"></select>
<select id="htmlQuizzes" style="display:none;"></select>
<select id="cssLessons" style="display:none;"></select>
<select id="cssQuizzes" style="display:none;"></select>
<select id="jsLessons" style="display:none;"></select>
<select id="jsQuizzes" style="display:none;"></select>
</main>

<footer>
<p>¬© 2025 MindCraft | Created by Group 3</p>
</footer>

<!--<script src="../Design/theme.js"></script>-->
<script>window.useFirestoreXP = true;</script>
<script src="../Exp/levels.js"></script>
<script type="module" src="../Feature/SLeaderboard/leaderboard.js"></script>

<!-- ‚úÖ Full Combined Populate + Blur Panel Script -->
<script>
document.addEventListener("DOMContentLoaded", () => {
function FullpopulateOptions(prefix, folder) {
const lessonSelect = document.getElementById(`${prefix}Lessons`);
if (lessonSelect) {
lessonSelect.innerHTML = "";
const placeholder = document.createElement("option");
placeholder.textContent = "üìñ Select Lesson";
placeholder.value = "";
lessonSelect.appendChild(placeholder);

const lessonOption = document.createElement("option");
lessonOption.value = `../Modular/Lessons/${folder}/lesson-Full.html`;
lessonOption.textContent = "Lesson Full";
lessonSelect.appendChild(lessonOption);
}

const quizSelect = document.getElementById(`${prefix}Quizzes`);
if (quizSelect) {
quizSelect.innerHTML = "";
const placeholder = document.createElement("option");
placeholder.textContent = "üìù Select Quiz";
placeholder.value = "";
quizSelect.appendChild(placeholder);

for (let i = 1; i <= 5; i++) {
const option = document.createElement("option");
option.value = `../Levels/Quiz/${folder}/level-${i}.html`;
option.textContent = `Level ${i}`;
quizSelect.appendChild(option);
}
}
}

function populateOptions(prefix, count, type, folder) {
const select = document.getElementById(`${prefix}${type}`);
if (!select) return;

const isLesson = type === "Lessons";
const label = isLesson ? "üìñ Select Lesson" : "üìù Select Quiz";
const subfolder = isLesson ? "Lessons" : "Quiz";
const basePath = isLesson
? `../Modular/${subfolder}/${folder}/lesson-`
: `../Levels/${subfolder}/${folder}/level-`;

select.innerHTML = "";
const placeholder = document.createElement("option");
placeholder.textContent = label;
placeholder.value = "";
select.appendChild(placeholder);

for (let i = 1; i <= count; i++) {
const option = document.createElement("option");
option.value = `${basePath}${i}.html`;
option.textContent = `${isLesson ? "Lesson" : "Level"} ${i}`;
select.appendChild(option);
}
}

//FullpopulateOptions("css", "CSS");
["html", "css", "js"].forEach(lang => {
populateOptions(lang, 5, "Lessons", lang.toUpperCase());
populateOptions(lang, 5, "Quizzes", lang.toUpperCase());
});

const cards = Array.from(document.querySelectorAll(".language-card"));
const lessonContainer = document.querySelector(".lesson-container");
if (!lessonContainer || cards.length === 0) return;

let left = lessonContainer.querySelector(".nav-arrow.left");
let right = lessonContainer.querySelector(".nav-arrow.right");

let idx = 0;
function setActive(i) {
idx = (i + cards.length) % cards.length;
cards.forEach((c, ii) => {
c.classList.toggle("active", ii === idx);
c.setAttribute("aria-hidden", ii === idx ? "false" : "true");
});
}
setActive(0);

left.onclick = () => setActive(idx - 1);
right.onclick = () => setActive(idx + 1);

let backdrop = document.getElementById("panelBackdrop");
if (!backdrop) {
backdrop = document.createElement("div");
backdrop.id = "panelBackdrop";
document.body.appendChild(backdrop);
}

let panel = document.querySelector(".language-panel");
if (!panel) {
panel = document.createElement("div");
panel.className = "language-panel";
panel.innerHTML = `
<div class="panel-title">
<img src="" alt="icon"><span class="titleText"></span>
</div>
<div class="panel-content"></div>
<button class="panel-back">‚¨á Back</button>
`;
document.body.appendChild(panel);
}

function getLangKeyFromCard(card) {
const data = (card.dataset && card.dataset.lang)
? card.dataset.lang.toLowerCase()
: (card.id || card.querySelector("p")?.textContent || "html").toLowerCase();
return data.replace(/\s+/g, "");
}

function openLanguagePanel(card) {
const langKey = getLangKeyFromCard(card);
const iconEl = panel.querySelector(".panel-title img");
const titleText = panel.querySelector(".panel-title .titleText");
const cardImg = card.querySelector("img");
iconEl.src = cardImg ? cardImg.src : "../Assets/Icons/html.png";
titleText.textContent = card.querySelector("p")?.textContent || langKey.toUpperCase();

const pc = panel.querySelector(".panel-content");
pc.innerHTML = `
<div class="lesson-dropdown">
<button class="lessons-btn">üìñ Lessons ‚ñæ</button>
<div class="lesson-list"></div>
</div>
<div class="quiz-dropdown">
<button class="quiz-btn">üìù Quiz ‚ñæ</button>
<div class="quiz-list"></div>
</div>
`;

const lessonList = pc.querySelector(".lesson-list");
const lessonSelect = document.getElementById(`${langKey}Lessons`);
lessonList.innerHTML = "";
if (lessonSelect && lessonSelect.options.length > 1) {
Array.from(lessonSelect.options).slice(1).forEach(opt => {
const b = document.createElement("button");
b.type = "button";
b.textContent = opt.textContent;
b.addEventListener("click", () => {
if (opt.value) window.location.href = opt.value;
});
lessonList.appendChild(b);
});
} else {
lessonList.innerHTML = '<button disabled>No lessons found</button>';
}

const lessonBtn = pc.querySelector(".lessons-btn");
lessonBtn.addEventListener("click", ev => {
ev.stopPropagation();
lessonList.style.display = lessonList.style.display === "flex" ? "none" : "flex";
});

const quizList = pc.querySelector(".quiz-list");
const quizSelect = document.getElementById(`${langKey}Quizzes`);
quizList.innerHTML = "";
if (quizSelect && quizSelect.options.length > 1) {
Array.from(quizSelect.options).slice(1).forEach(opt => {
const b = document.createElement("button");
b.type = "button";
b.textContent = opt.textContent;
b.addEventListener("click", () => {
if (opt.value) window.location.href = opt.value;
});
quizList.appendChild(b);
});
} else {
quizList.innerHTML = '<button disabled>No quizzes found</button>';
}

const quizBtn = pc.querySelector(".quiz-btn");
quizBtn.addEventListener("click", ev => {
ev.stopPropagation();
quizList.style.display = quizList.style.display === "flex" ? "none" : "flex";
});

const backBtn = panel.querySelector(".panel-back");
backBtn.addEventListener("click", closeLanguagePanel);

backdrop.style.display = "block";
panel.style.display = "flex";
document.body.classList.add("blur-active");
document.body.style.overflow = "hidden";
}

function closeLanguagePanel() {
panel.style.display = "none";
panel.classList.remove("opening");

const quizLists = panel.querySelectorAll(".quiz-list");
quizLists.forEach(list => {
list.style.display = "none";
list.innerHTML = "";
});

const content = panel.querySelector(".panel-content");
if (content) content.innerHTML = "";

const titleImg = panel.querySelector(".panel-title img");
const titleText = panel.querySelector(".panel-title .titleText");
if (titleImg) titleImg.src = "";
if (titleText) titleText.textContent = "";

backdrop.style.display = "none";
document.body.classList.remove("blur-active");
document.body.style.overflow = "";
}

backdrop.addEventListener("click", e => {
e.stopPropagation();
e.preventDefault();
});

cards.forEach((card, i) => {
card.addEventListener("click", () => {
if (!card.classList.contains("active")) {
setActive(i);
setTimeout(() => openLanguagePanel(card), 160);
} else {
openLanguagePanel(card);
}
});

card.addEventListener("keydown", ev => {
if (ev.key === "Enter" || ev.key === " ") {
ev.preventDefault();
openLanguagePanel(card);
}
});
});
});
</script>

<!-- ‚úÖ Firebase Auth / XP / Rank / Welcome Overlay -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, onSnapshot, collection, query, orderBy, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
apiKey: "AIzaSyAQBwwuXwh82MCRyJ_7CBk2aWUp-n6p4DQ",
authDomain: "mindcraft-83f81.firebaseapp.com",
projectId: "mindcraft-83f81",
storageBucket: "mindcraft-83f81.firebasestorage.app",
messagingSenderId: "483019456762",
appId: "1:483019456762:web:fdc05a2dda51c0f39a8943"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

function animateXPBar(bar, startValue, endValue, duration = 600) {
if (!bar) return;
const startTime = performance.now();
function update(currentTime) {
const elapsed = currentTime - startTime;
const progress = Math.min(elapsed / duration, 1);
const currentValue = startValue + (endValue - startValue) * progress;
bar.value = currentValue;
if (progress < 1) requestAnimationFrame(update);
}
requestAnimationFrame(update);
}

let lastXP = 0;
let lastLevel = 0;

function formatNumberSmart(value) {
const abs = Math.abs(value);
const units = [
{ v: 1e99, s: "Ce" },
{ v: 1e96, s: "NoCe" },
{ v: 1e93, s: "OcCe" },
{ v: 1e90, s: "SeCe" },
{ v: 1e87, s: "SxCe" },
{ v: 1e84, s: "QiCe" },
{ v: 1e81, s: "QdCe" },
{ v: 1e78, s: "TrCe" },
{ v: 1e75, s: "DuCe" },
{ v: 1e72, s: "UnCe" },
{ v: 1e69, s: "Vi" },
{ v: 1e66, s: "Nv" },
{ v: 1e63, s: "Oc" },
{ v: 1e60, s: "Spt" },
{ v: 1e57, s: "Sxd" },
{ v: 1e54, s: "Qid" },
{ v: 1e51, s: "Qad" },
{ v: 1e48, s: "Td" },
{ v: 1e45, s: "Dd" },
{ v: 1e42, s: "Und" },
{ v: 1e39, s: "Dc" },
{ v: 1e36, s: "Nn" },
{ v: 1e33, s: "Oc" },
{ v: 1e30, s: "Sp" },
{ v: 1e27, s: "Sx" },
{ v: 1e24, s: "Qi" },
{ v: 1e21, s: "Qd" },
{ v: 1e18, s: "T" },
{ v: 1e15, s: "B" },
{ v: 1e12, s: "M" },
{ v: 1e9, s: "K" }
];
for (const u of units) {
if (abs >= u.v) {
const shortened = (value / u.v).toFixed(value >= 1e6 ? 2 : 3);
return shortened.replace(/\.00$|\.0$/, "") + u.s;
}
}
return value.toString();
}

function formatNumberFull(value) {
return value.toLocaleString("en-US");
}

function adjustXPFont(xpValueElement, xpMax) {
if (!xpValueElement) return;
const len = xpMax.toString().length;
let newSize = 0.5;
if (len > 6 && len <= 9) newSize = 0.45;
else if (len > 9 && len <= 12) newSize = 0.4;
else if (len > 12 && len <= 18) newSize = 0.35;
else if (len > 18 && len <= 25) newSize = 0.32;
else if (len > 25 && len <= 35) newSize = 0.3;
xpValueElement.style.fontSize = `${newSize}rem`;
}

let xpShortMode = true;

function updateXPDisplay(xp, xpMax) {
const xpValue = document.getElementById("xpValue");
if (!xpValue) return;
const shortForm = `${formatNumberSmart(xp)} / ${formatNumberSmart(xpMax)}`;
const fullForm = `${formatNumberFull(xp)} / ${formatNumberFull(xpMax)}`;
xpValue.textContent = xpShortMode ? shortForm : fullForm;
adjustXPFont(xpValue, xpMax);
}

function toggleXPFormat() {
xpShortMode = !xpShortMode;
const xpBar = document.getElementById("xpBar");
const xp = parseFloat(xpBar?.value || 0);
const xpMax = parseFloat(xpBar?.max || 100);
updateXPDisplay(xp, xpMax);
}

document.addEventListener("DOMContentLoaded", () => {
const xpValue = document.getElementById("xpValue");
if (xpValue) {
xpValue.addEventListener("click", toggleXPFormat);
}
});

onAuthStateChanged(auth, (user) => {
if (!user) {
alert("‚ö†Ô∏è Please sign in first!");
window.location.href = "../Account/signin.html";
return;
}

const userRef = doc(db, "users", user.uid);
onSnapshot(userRef, async (snap) => {
if (!snap.exists()) {
alert("‚ö†Ô∏è No user data found.");
window.location.href = "../Account/signin.html";
return;
}

const data = snap.data();
if (data.role !== "student") {
window.location.href = "Teacher.html";
return;
}

const xp = data.xp ?? 0;
const level = data.level ?? 1;
let xpMax = data.xpMax ?? 100;

const expectedXpMax = Math.floor(100 * Math.pow(1.1, level - 1));
if (Math.abs(xpMax - expectedXpMax) > 5) {
xpMax = expectedXpMax;
try { await updateDoc(userRef, { xpMax }); }
catch { }
}

const xpBar = document.getElementById("xpBar");
const xpValue = document.getElementById("xpValue");
const levelValue = document.getElementById("levelValue");
xpBar.max = xpMax;
animateXPBar(xpBar, lastXP, xp);
lastXP = xp;

updateXPDisplay(xp, xpMax);
levelValue.textContent = level;
lastLevel = level;

const name = user.displayName || data.name || user.email.split("@")[0];
document.getElementById("studentName").textContent = name;
const welcomeOverlay = document.getElementById("welcomeOverlay");
if (!sessionStorage.getItem("welcomeShown")) {
sessionStorage.setItem("welcomeShown", "true");
welcomeOverlay.style.display = "flex";
setTimeout(() => {
welcomeOverlay.classList.add("fade-out");
setTimeout(() => (welcomeOverlay.style.display = "none"), 600);
}, 3000);
}

const rankDisplay = document.getElementById("rankDisplay");
const usersRef = collection(db, "users");
const q = query(usersRef, orderBy("level", "desc"), orderBy("xp", "desc"));
onSnapshot(q, (snapshot) => {
let rank = 1, found = false;
snapshot.forEach((docSnap) => {
if (docSnap.id === user.uid && !found) { found = true; return; }
if (!found) rank++;
});
rankDisplay.textContent = `Rank: #${rank}`;
if (rank <= 3) rankDisplay.classList.add("rank-top");
else rankDisplay.classList.remove("rank-top");
});
});
});
</script>

</body>
</html>
