<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sign In - MindCraft</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<link rel="stylesheet" href="../Design/Position.css">

<style>
body { 
  font-family: 'Press Start 2P', cursive; 
  text-align: center; 
  background: #203a43; 
  color: white; 
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
}
input { 
  padding: 10px; 
  width: 70%; 
  margin: 10px; 
  border-radius: 8px; 
  border: none; 
  font-family: 'Press Start 2P', cursive;
  font-size: 0.6rem;
}
button { 
  padding: 10px 20px; 
  border: none; 
  border-radius: 8px; 
  background: #1DB954; 
  color: white; 
  cursor: pointer; 
  font-family: 'Press Start 2P', cursive;
  font-size: 0.6rem;
  margin: 5px;
  transition: background 0.3s;
}
button:hover { background: #1ed760; }
.message { margin: 10px; color: #ff5252; font-size: 0.6rem; }
.choice-section, .student-form, .teacher-form { display: none; }
.choice-section { display: block; }

/* Back Buttons */
.back-buttons {
  position: absolute;
  top: 20px;
  left: 20px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.back-buttons button {
  width: 160px;
  background: #666;
}
.back-buttons button:hover { background: #888; }

.resend-btn {
  background: #ff69b4;
  color: white;
  border: none;
  border-radius: 6px;
  padding: 6px 12px;
  font-size: 0.6rem;
  margin-top: 5px;
  cursor: pointer;
}
.resend-btn:hover { background: #ff85c1; }
</style>
</head>
<body>

<!-- Back Buttons -->
<div class="back-buttons">
  <button id="homeBtn">üè† Home</button>
  <button id="formBackBtn" style="display:none;">‚¨Ö Back to Form</button>
</div>

<!-- Role Selection -->
<div class="choice-section" id="choiceSection">
  <h2>üß† MindCraft - Sign In</h2>
  <p>Choose your role:</p>
  <button id="studentBtn">Student</button>
  <button id="teacherBtn">Teacher</button>
</div>

<!-- Student Form -->
<div class="student-form" id="studentForm">
  <h2>Student Sign In</h2>
  <form id="studentSigninForm">
    <input type="email" id="studentEmail" placeholder="Enter Gmail" required><br>
    <input type="password" id="studentPassword" placeholder="Enter password" required><br>
    <button type="submit">Sign In</button>
  </form>
  <p class="message" id="studentMessage"></p>
  <button id="resendStudent" class="resend-btn" style="display:none;">‚úâÔ∏è Resend Verification Email</button>
  <p>Don‚Äôt have an account? <a href="signup.html" style="color:#1DB954;">Sign up here</a>.</p>
</div>

<!-- Teacher Form -->
<div class="teacher-form" id="teacherForm">
  <h2>Teacher Sign In</h2>
  <form id="teacherSigninForm">
    <input type="email" id="teacherEmail" placeholder="Enter DepEd email" required><br>
    <input type="password" id="teacherPassword" placeholder="Enter password" required><br>
    <button type="submit">Sign In</button>
  </form>
  <p class="message" id="teacherMessage"></p>
  <button id="resendTeacher" class="resend-btn" style="display:none;">‚úâÔ∏è Resend Verification Email</button>
  <p>Don‚Äôt have an account? <a href="signup.html" style="color:#1DB954;">Sign up here</a>.</p>
</div>

<script type="module">
import { auth, db } from '../System/Database/firebase.js';
import {
  signInWithEmailAndPassword,
  signOut,
  sendEmailVerification,
  sendPasswordResetEmail
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getDoc, setDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// ===== Navigation Buttons =====
document.getElementById("homeBtn").addEventListener("click", () => {
  window.location.href = "../../index.html";
});

// ===== UI Toggle =====
function showStudentForm() {
  document.getElementById('choiceSection').style.display = 'none';
  document.getElementById('studentForm').style.display = 'block';
  document.getElementById('formBackBtn').style.display = 'block';
  document.getElementById('homeBtn').style.display = 'none';
}

function showTeacherForm() {
  document.getElementById('choiceSection').style.display = 'none';
  document.getElementById('teacherForm').style.display = 'block';
  document.getElementById('formBackBtn').style.display = 'block';
  document.getElementById('homeBtn').style.display = 'none';
}

function backToChoice() {
  document.getElementById('studentForm').style.display = 'none';
  document.getElementById('teacherForm').style.display = 'none';
  document.getElementById('choiceSection').style.display = 'block';
  document.getElementById('formBackBtn').style.display = 'none';
  document.getElementById('homeBtn').style.display = 'block';
  document.getElementById('studentSigninForm').reset();
  document.getElementById('teacherSigninForm').reset();
  document.getElementById('studentMessage').textContent = '';
  document.getElementById('teacherMessage').textContent = '';
}

document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("studentBtn").addEventListener("click", showStudentForm);
  document.getElementById("teacherBtn").addEventListener("click", showTeacherForm);
  document.getElementById("formBackBtn").addEventListener("click", backToChoice);
});

// ==== Default Student Fields ====
const defaultStudentFields = {
  level: 1, xp: 0, xpMax: 100, totalXP: 0,
  completedLessons: [], completedQuizzes: []
};

// ==== Sign In (Student) ====
document.getElementById('studentSigninForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const email = document.getElementById('studentEmail').value.trim();
  const password = document.getElementById('studentPassword').value;
  const msg = document.getElementById('studentMessage');
  const resendBtn = document.getElementById('resendStudent');

  msg.textContent = "";
  resendBtn.style.display = "none";

  try {
    const userCred = await signInWithEmailAndPassword(auth, email, password);
    const user = userCred.user;

    if (!user.emailVerified) {
      msg.textContent = "‚ö†Ô∏è Please verify your email before signing in.";
      resendBtn.style.display = "inline-block";
      await signOut(auth);
      return;
    }

    const userRef = doc(db, "users", user.uid);
    const snap = await getDoc(userRef);
    if (!snap.exists() || snap.data().role !== "student") {
      msg.textContent = "‚ùå This account is not a student.";
      await signOut(auth);
      return;
    }

    let data = snap.data();
    for (const key in defaultStudentFields) {
      if (!(key in data)) data[key] = defaultStudentFields[key];
    }

    await setDoc(userRef, data, { merge: true });

    localStorage.setItem("currentUser", user.uid);
    localStorage.setItem("cachedName", data.name || "Student");
    localStorage.setItem("currentRole", "student");

    msg.style.color = "#1DB954";
    msg.textContent = "‚úÖ Sign in successful! Redirecting...";

    setTimeout(async () => {
      let tries = 0;
      while (!auth.currentUser && tries < 10) {
        await new Promise(res => setTimeout(res, 300));
        tries++;
      }
      window.location.href = "../Startup/StartupS.html";
    }, 1200);

  } catch (err) {
    console.error("Sign-in error:", err);
    msg.textContent = `‚ùå ${err.message}`;
  }
});

// ==== Forgot Password (Student) ====
const studentForgotBtn = document.createElement("button");
studentForgotBtn.textContent = "üîë Forgot Password?";
studentForgotBtn.className = "resend-btn";
studentForgotBtn.style.background = "#ffae42";
studentForgotBtn.style.marginTop = "5px";
studentForgotBtn.onclick = async () => {
  const email = document.getElementById("studentEmail").value.trim();
  const msg = document.getElementById("studentMessage");
  if (!email) {
    msg.textContent = "‚ö†Ô∏è Enter your Gmail first to reset password.";
    return;
  }
  try {
    await sendPasswordResetEmail(auth, email);
    msg.style.color = "#1DB954";
    msg.textContent = "‚úÖ Password reset email sent! Check your inbox.";
  } catch (err) {
    msg.style.color = "#ff5252";
    msg.textContent = `‚ùå ${err.message}`;
  }
};
document.getElementById("studentForm").appendChild(studentForgotBtn);

// ==== Resend Verification (Student) ====
document.getElementById("resendStudent").addEventListener("click", async () => {
  const email = document.getElementById("studentEmail").value.trim();
  const password = document.getElementById("studentPassword").value;
  const msg = document.getElementById("studentMessage");

  try {
    const userCred = await signInWithEmailAndPassword(auth, email, password);
    const user = userCred.user;
    await sendEmailVerification(user);
    msg.textContent = "‚úâÔ∏è Verification email sent again. Check your inbox!";
    await signOut(auth);
  } catch (err) {
    msg.textContent = `‚ùå ${err.message}`;
  }
});

// ==== Sign In (Teacher) ====
document.getElementById('teacherSigninForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const email = document.getElementById('teacherEmail').value.trim();
  const password = document.getElementById('teacherPassword').value;
  const msg = document.getElementById('teacherMessage');
  const resendBtn = document.getElementById('resendTeacher');

  msg.textContent = "";
  resendBtn.style.display = "none";

  try {
    const userCred = await signInWithEmailAndPassword(auth, email, password);
    const user = userCred.user;

    if (!user.emailVerified) {
      msg.textContent = "‚ö†Ô∏è Please verify your email before signing in.";
      resendBtn.style.display = "inline-block";
      await signOut(auth);
      return;
    }

    const userRef = doc(db, "users", user.uid);
    const snap = await getDoc(userRef);
    if (!snap.exists() || snap.data().role !== "teacher") {
      msg.textContent = "‚ùå This account is not a teacher.";
      await signOut(auth);
      return;
    }

    localStorage.setItem("currentUser", user.uid);
    localStorage.setItem("cachedName", snap.data().name || "Teacher");
    localStorage.setItem("currentRole", "teacher");

    msg.style.color = "#1DB954";
    msg.textContent = "‚úÖ Sign in successful! Redirecting...";

    setTimeout(() => {
      window.location.href = "../Startup/StartupT.html";
    }, 1200);

  } catch (err) {
    console.error("Teacher sign-in error:", err);
    msg.textContent = `‚ùå ${err.message}`;
  }
});

// ==== Forgot Password (Teacher) ====
const teacherForgotBtn = document.createElement("button");
teacherForgotBtn.textContent = "üîë Forgot Password?";
teacherForgotBtn.className = "resend-btn";
teacherForgotBtn.style.background = "#ffae42";
teacherForgotBtn.style.marginTop = "5px";
teacherForgotBtn.onclick = async () => {
  const email = document.getElementById("teacherEmail").value.trim();
  const msg = document.getElementById("teacherMessage");
  if (!email) {
    msg.textContent = "‚ö†Ô∏è Enter your DepEd email first to reset password.";
    return;
  }
  try {
    await sendPasswordResetEmail(auth, email);
    msg.style.color = "#1DB954";
    msg.textContent = "‚úÖ Password reset email sent! Check your inbox.";
  } catch (err) {
    msg.style.color = "#ff5252";
    msg.textContent = `‚ùå ${err.message}`;
  }
};
document.getElementById("teacherForm").appendChild(teacherForgotBtn);

// ==== Resend Verification (Teacher) ====
document.getElementById("resendTeacher").addEventListener("click", async () => {
  const email = document.getElementById("teacherEmail").value.trim();
  const password = document.getElementById("teacherPassword").value;
  const msg = document.getElementById("teacherMessage");

  try {
    const userCred = await signInWithEmailAndPassword(auth, email, password);
    const user = userCred.user;
    await sendEmailVerification(user);
    msg.textContent = "‚úâÔ∏è Verification email sent again. Check your inbox!";
    await signOut(auth);
  } catch (err) {
    msg.textContent = `‚ùå ${err.message}`;
  }
});
</script>
</body>
    </html>
