<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Level 1 - HTML Quiz | MindCraft</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<link rel="stylesheet" href="../../../Design/levels.css">
<link rel="stylesheet" href="../../../Design/global_size-FIX.css">

<style>
body {
  font-family: 'Press Start 2P', cursive;
  color: #fff;
  text-align: center;
  margin: 0;
  padding: 0;
  transition: background 0.5s, color 0.5s;
}
.quiz-container {
  max-width: 700px;
  margin: 50px auto;
  padding: 25px;
  background: rgba(0,0,0,0.5);
  border-radius: 12px;
  box-shadow: 0 0 15px #1DB954;
}
h2 { color: #1DB954; margin-bottom: 10px; font-size: clamp(0.8rem, 2vw, 0.9rem); }
h4 { font-size: clamp(0.5rem, 1.5vw, 0.6rem); }
.choice {
  display: block;
  margin: 10px auto;
  padding: 12px;
  width: 80%;
  max-width: 400px;
  border-radius: 10px;
  background: #1DB954;
  cursor: pointer;
  color: #fff;
  border: none;
  transition: transform 0.2s, background 0.3s;
  font-family: 'Press Start 2P', cursive;
  font-size: clamp(0.5rem, 1.5vw, 0.6rem);
}
.choice:hover { background: #1ed760; transform: scale(1.05); }
#result { margin-top: 20px; font-size: clamp(0.6rem, 1.5vw, 0.7rem); }
#nextBtn, #finishBtn {
  margin-top: 15px;
  padding: 10px 20px;
  background: #1DB954;
  border: none;
  border-radius: 10px;
  color: #fff;
  font-weight: bold;
  cursor: pointer;
  display: none;
  font-size: clamp(0.5rem, 1.5vw, 0.6rem);
  transition: transform 0.3s;
  font-family: 'Press Start 2P', cursive;
}
#nextBtn:hover, #finishBtn:hover { background: #1ed760; transform: scale(1.1); }
#popupOverlay {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.85);
  display: none;
  justify-content: center;
  align-items: center;
  flex-direction: column;
  color: #fff;
  z-index: 999;
  animation: fadeIn 0.8s ease;
  padding-bottom: 10vh;
}
@keyframes fadeIn { from {opacity:0;} to {opacity:1;} }
#xpGain {
  color: #1DB954;
  font-size: clamp(0.7rem, 2vw, 0.8rem);
  margin: 10px 0;
}
.xp-bar-container {
  width: 60%;
  background: #222;
  border-radius: 8px;
  height: 16px;
  overflow: hidden;
  margin: 15px auto;
}
.xp-bar-fill {
  background: linear-gradient(90deg, #00ff90, #1DB954);
  width: 0%;
  height: 100%;
  transition: width 1.5s ease-in-out;
}
#backBtn {
  background: #ff69b4;
  border: none;
  border-radius: 8px;
  color: #fff;
  padding: 10px 18px;
  font-family: 'Press Start 2P', cursive;
  margin-top: 20px;
  cursor: pointer;
  font-size: clamp(0.5rem, 1.5vw, 0.6rem);
}
#backBtn:hover { background: #ff85c1; transform: scale(1.05); }
.fade-out {
  animation: fadeOut 1s ease forwards;
}
@keyframes fadeOut {
  from { opacity: 1; }
  to { opacity: 0; transform: scale(0.98); }
}
</style>
</head>
<body>

<div class="quiz-container">
  <h2>Grade 11 Quiz - Level 1: HTML Basics</h2>
  <h4 id="progress">Question 1 of 10</h4>
  <h4 id="timer">Time Left: 15:00</h4>
  <div id="questionContainer"></div>
  <div id="result"></div>
  <button id="nextBtn">Next Question</button>
  <button id="finishBtn">Finish Level</button>
</div>

<div id="popupOverlay">
  <h2>üéâ Level Complete!</h2>
  <p id="xpGain">+0 XP Gained</p>
  <div class="xp-bar-container">
    <div class="xp-bar-fill" id="xpBarFill"></div>
  </div>
  <button id="backBtn">‚¨Ö Back to Lobby</button>
</div>

<!-- ‚úÖ Corrected sound file paths -->
<audio id="correctSound" src="../../../Assets/Sounds/Correct.mp3"></audio>
<audio id="wrongSound" src="../../../Assets/Sounds/Incorrect.mp3"></audio>

<!-- ‚úÖ Theme loader -->
<script src="../../../Design/theme.js"></script>
<script>
window.addEventListener('DOMContentLoaded', () => {
  if (typeof window.applyTheme === 'function') {
    const currentTheme = localStorage.getItem('theme') || 'dark';
    window.applyTheme(currentTheme, false);
  } else {
    document.body.style.background = '#111'; // fallback
  }
});
</script>

<!-- ‚úÖ Firebase + Quiz Logic -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import "../../../Design/navigate_return.js";
import "../../../Design/theme.js";

const firebaseConfig = {
  apiKey: "AIzaSyAQBwwuXwh82MCRyJ_7CBk2aWUp-n6p4DQ",
  authDomain: "mindcraft-83f81.firebaseapp.com",
  projectId: "mindcraft-83f81",
  storageBucket: "mindcraft-83f81.firebasestorage.app",
  messagingSenderId: "483019456762",
  appId: "1:483019456762:web:fdc05a2dda51c0f39a8943"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// üß† Verify Firebase user + role before quiz starts
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    alert("‚ö†Ô∏è You must be signed in to access the quiz!");
    window.location.href = "../../../Account/signin.html";
    return;
  }

  try {
    const snap = await getDoc(doc(db, "users", user.uid));
    if (!snap.exists()) {
      alert("‚ö†Ô∏è User data not found!");
      window.location.href = "../../../Account/signin.html";
      return;
    }

    const role = snap.data().role || "student";
    if (role !== "student") {
      alert("üö´ Only students can take this quiz!");
      window.location.href = "../../../Webside/Teacher.html";
      return;
    }

    // ‚úÖ Authorized student ‚Äî start quiz
    initQuiz();

  } catch (err) {
    console.error("Role check error:", err);
    alert("‚ö†Ô∏è Error verifying user. Please log in again.");
    window.location.href = "../../../Account/signin.html";
  }
});

// ==================== QUIZ FUNCTIONALITY ==================== //
function initQuiz() {
  let currentQuestion = 0;
  let xpEarned = 0;
  const XP_PER_QUESTION = 5;

  const quizQuestions = [
    { question: "What does HTML stand for?", choices: ["Hyper Text Markup Language", "High Text Machine Language", "Hyperlinks and Text Mark Language", "Home Tool Markup Language"], answer: 0 },
    { question: "Which HTML element is used to define a paragraph?", choices: ["<p>", "<h1>", "<div>", "<span>"], answer: 0 },
    { question: "Which attribute is used to link a CSS file in HTML?", choices: ["href", "src", "link", "rel"], answer: 0 },
    { question: "What is the correct HTML element for the largest heading?", choices: ["<h6>", "<heading>", "<h1>", "<head>"], answer: 2 },
    { question: "Which HTML element is used to display an image?", choices: ["<img>", "<picture>", "<image>", "<src>"], answer: 0 },
    { question: "How do you create a hyperlink in HTML?", choices: ["<a href='url'>link</a>", "<link>link</link>", "<hyperlink url=''>link</hyperlink>", "<url>link</url>"], answer: 0 },
    { question: "Which HTML element defines an unordered list?", choices: ["<ul>", "<ol>", "<li>", "<list>"], answer: 0 },
    { question: "Which attribute specifies an alternative text for an image?", choices: ["alt", "src", "title", "text"], answer: 0 },
    { question: "Which HTML element is used for inserting a line break?", choices: ["<break>", "<lb>", "<br>", "<hr>"], answer: 2 },
    { question: "Which tag is used to define the document‚Äôs title?", choices: ["<title>", "<head>", "<meta>", "<header>"], answer: 0 }
  ];

  const questionContainer = document.getElementById("questionContainer");
  const nextBtn = document.getElementById("nextBtn");
  const finishBtn = document.getElementById("finishBtn");
  const result = document.getElementById("result");
  const progress = document.getElementById("progress");
  const timerEl = document.getElementById("timer");
  const correctSound = document.getElementById("correctSound");
  const wrongSound = document.getElementById("wrongSound");
  const soundEnabled = localStorage.getItem('sound') === 'on';
  const vibrationEnabled = localStorage.getItem('vibration') === 'on';
  const isMobile = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

  // TIMER
  let totalTime = 15 * 60;
  const interval = setInterval(() => {
    if (totalTime <= 0) { clearInterval(interval); showPopup(); return; }
    totalTime--;
    const m = Math.floor(totalTime / 60);
    const s = totalTime % 60;
    timerEl.textContent = `Time Left: ${m}:${s.toString().padStart(2,'0')}`;
  }, 1000);

  // LOAD QUESTION
  function loadQuestion() {
    result.textContent = "";
    nextBtn.style.display = "none";
    finishBtn.style.display = "none";
    questionContainer.innerHTML = "";
    if (currentQuestion >= quizQuestions.length) return;

    const q = quizQuestions[currentQuestion];
    progress.textContent = `Question ${currentQuestion + 1} of ${quizQuestions.length}`;
    const questionEl = document.createElement("h3");
    questionEl.textContent = q.question;
    questionContainer.appendChild(questionEl);

    q.choices.forEach((choice, i) => {
      const btn = document.createElement("button");
      btn.textContent = choice;
      btn.className = "choice";
      btn.onclick = () => checkAnswer(i);
      questionContainer.appendChild(btn);
    });
  }

  // CHECK ANSWER
  function checkAnswer(selectedIndex) {
    const correctIndex = quizQuestions[currentQuestion].answer;
    const choices = document.querySelectorAll(".choice");
    choices.forEach(b => b.disabled = true);

    if (selectedIndex === correctIndex) {
      result.textContent = `‚úÖ Correct! +${XP_PER_QUESTION} XP`;
      xpEarned += XP_PER_QUESTION;
      if (soundEnabled) correctSound.play();
      if (vibrationEnabled && isMobile && navigator.vibrate) navigator.vibrate(100);
    } else {
      result.textContent = "‚ùå Wrong! No XP";
      if (soundEnabled) wrongSound.play();
      if (vibrationEnabled && isMobile && navigator.vibrate) navigator.vibrate([200,100,200]);
    }

    nextBtn.style.display = (currentQuestion < quizQuestions.length - 1) ? "inline-block" : "none";
    finishBtn.style.display = (currentQuestion === quizQuestions.length - 1) ? "inline-block" : "none";
  }

  nextBtn.onclick = () => { currentQuestion++; loadQuestion(); };
  finishBtn.onclick = () => { clearInterval(interval); showPopup(); };

  // ‚úÖ SAVE XP TO FIRESTORE
  async function showPopup() {
    document.querySelector(".quiz-container").classList.add('fade-out');
    const popup = document.getElementById("popupOverlay");

    try {
      const user = auth.currentUser;
      if (user) {
        const userRef = doc(db, "users", user.uid);
        const snap = await getDoc(userRef);
        let data = snap.exists() ? snap.data() : {};
        let oldXP = data.xp || 0;
        let oldLevel = data.level || 1;
        let xpMax = data.xpMax || 100;

        let newXP = oldXP + xpEarned;
        let newLevel = oldLevel;

        while (newXP >= xpMax) {
          newXP -= xpMax;
          newLevel++;
          xpMax = Math.floor(xpMax * 1.1);
        }

        await updateDoc(userRef, {
          xp: newXP,
          level: newLevel,
          xpMax: xpMax
        });

        localStorage.setItem(`${user.uid}_xp`, newXP);
        localStorage.setItem(`${user.uid}_level`, newLevel);

        console.log(`‚úÖ XP Saved: +${xpEarned} (Total: ${newXP}, Level: ${newLevel})`);
      }
    } catch (err) {
      console.error("‚ö†Ô∏è Error saving XP:", err);
    }

    setTimeout(() => {
      document.querySelector(".quiz-container").style.display = "none";
      popup.style.display = "flex";
      document.getElementById("xpGain").textContent = `+${xpEarned} XP Gained`;
      setTimeout(() => {
        document.getElementById("xpBarFill").style.width = "100%";
      }, 300);
    }, 800);
  }

  // BACK BUTTON
  document.getElementById('backBtn').onclick = () => {
    const popup = document.getElementById('popupOverlay');
    popup.classList.add('fade-out');
    setTimeout(() => window.location.href = '../../../Webside/Student.html', 1000);
  };

  loadQuestion();
}
</script>
</body>
</html>
