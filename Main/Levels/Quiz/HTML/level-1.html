<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MindCraft HTML Lesson / Quiz</title>

<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

<style>
/* ---------- Page & Scene ---------- */
* { box-sizing: border-box; }
html,body { height:100%; margin:0; padding:0; font-family:'Press Start 2P',cursive; background:#eafcff; color:#000; }
.scene {
  position: relative;
  width:100%;
  max-width:1200px;
  min-height:92vh;
  margin: 20px auto;
  background: linear-gradient(120deg,#eafcff,#c6f0ff,#a4e2c1,#74cfa0);
  background-size:300% 300%;
  animation: bgShift 12s ease infinite;
  border-radius:28px;
  box-shadow:0 50px 100px rgba(0,0,0,.35);
  overflow:hidden;
  padding:20px 40px;
}
@keyframes bgShift { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }

.grid { position:absolute; inset:0;
  background-image:
    linear-gradient(rgba(255,255,255,.08) 1px, transparent 1px),
    linear-gradient(90deg, rgba(255,255,255,.08) 1px, transparent 1px);
  background-size:60px 60px; opacity:.25;
}

/* ---------- Title ---------- */
.title {
  position:absolute; top:20px; left:50%; transform:translateX(-50%);
  padding:18px 48px; background:linear-gradient(#c97a36,#8b4d1a);
  color:white; font-size:1.6rem; border-radius:20px; text-shadow:4px 4px 0 black;
  z-index:5; text-align:center;
}
@media (max-width:768px){
  .title { font-size:1.2rem; padding:12px 26px; }
}

/* ---------- Menu / Questions ---------- */
.menu { position:relative; margin-top:140px; display:flex; flex-direction:column; gap:16px; z-index:5; padding-bottom:40px; }
.question {
  background: rgba(255,255,255,.15);
  backdrop-filter: blur(8px);
  padding:18px 24px;
  border-radius:18px;
  color:#000;
  display:flex; flex-direction:column; gap:10px;
}
.question strong { display:block; margin-bottom:6px; }
.question label { cursor:pointer; display:block; background:linear-gradient(#ffe08a,#f2a933);
  padding:12px 16px; border-radius:12px; transition: .14s ease; user-select:none; font-size:0.92rem; }
.question label:hover { transform: translateX(6px); }
.question input[type="text"] { padding:10px; border-radius:12px; border:none; font-family:'Press Start 2P'; }

/* ---------- Next / Finish ---------- */
button.next, button.finish {
  align-self:center; margin-top:12px; background:linear-gradient(#46b46b,#2e7d4a);
  color:white; font-size:.8rem; padding:14px 28px; border:none; border-radius:18px; cursor:pointer;
  box-shadow:0 6px 0 rgba(0,0,0,.25);
}
button.next:hover, button.finish:hover { transform: translateY(-4px); box-shadow:0 8px 0 rgba(0,0,0,.35); }

/* ---------- Ground & footer ---------- */
.ground { position:absolute; bottom:0; width:100%; height:120px; background:linear-gradient(#46b46b,#2e7d4a); box-shadow:inset 0 12px 0 rgba(255,255,255,.25); }
footer { position:absolute; bottom:10px; width:100%; text-align:center; font-size:.55rem; color:white; text-shadow:1px 1px 0 black; }

/* ---------- XP Popup Overlay ---------- */
#popupOverlay {
  position: fixed; inset:0; display:none; z-index:9999;
  justify-content:center; align-items:center; flex-direction:column;
  background: rgba(0,0,0,0.65);
  padding: 8vh 16px;
}
.popup-card {
  width:100%; max-width:640px; background: rgba(0,0,0,0.92); border:2px solid #1DB954;
  border-radius:12px; padding:22px; color:#fff; text-align:center; box-shadow:0 0 30px #1DB95466;
}
#xpGain { color:#1DB954; font-size:clamp(0.8rem,2vw,1.0rem); margin:10px 0; }
.xp-bar-container { width:70%; height:16px; background:#222; border-radius:8px; margin:12px auto; overflow:hidden; }
.xp-bar-fill { width:0%; height:100%; background:linear-gradient(90deg,#00ff90,#1DB954); transition: width 1.4s ease-in-out; border-radius:6px; }
#backBtn { margin-top:14px; background:#1DB954; color:#fff; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; font-family:'Press Start 2P'; }
#backBtn:hover { transform:scale(1.03); }

/* ---------- Small helpers ---------- */
.hidden { display:none !important; }
.fade-out { animation: fadeOut .8s ease forwards; }
@keyframes fadeOut { from {opacity:1} to {opacity:0; transform:scale(.98);} }

/* ---------- Responsive ---------- */
@media (max-width:720px) {
  .scene { padding:18px 18px; min-height:85vh; border-radius:18px; }
  .question label { font-size:0.9rem; }
  button.next, button.finish { font-size:0.78rem; padding:12px 20px; }
  .popup-card { padding:16px; }
  .xp-bar-container { width:85%; }
  .title { font-size:1.2rem; padding:10px 18px; top:14px; }
}
</style>
</head>
<body>

<div class="scene">
  <div class="grid"></div>
  <div class="title">Lesson 1: HTML Structure & Elements</div>

  <div class="menu" id="menu">
    <!-- Questions (10 questions) -->
    <div class="question" id="q1">
      <strong>1. Which tag wraps all HTML content?</strong>
      <label><input type="radio" name="q1" value="0"> A. &lt;html&gt;</label>
      <label><input type="radio" name="q1" value="1"> B. &lt;head&gt;</label>
      <label><input type="radio" name="q1" value="2"> C. &lt;body&gt;</label>
      <label><input type="radio" name="q1" value="3"> D. &lt;title&gt;</label>
    </div>

    <div class="question" id="q2">
      <strong>2. Which element contains metadata like title and CSS links?</strong>
      <label><input type="radio" name="q2" value="0"> A. &lt;html&gt;</label>
      <label><input type="radio" name="q2" value="1"> B. &lt;head&gt;</label>
      <label><input type="radio" name="q2" value="2"> C. &lt;body&gt;</label>
      <label><input type="radio" name="q2" value="3"> D. &lt;p&gt;</label>
    </div>

    <div class="question" id="q3">
      <strong>3. Which of the following is a valid HTML comment?</strong>
      <label><input type="radio" name="q3" value="0"> A. // comment</label>
      <label><input type="radio" name="q3" value="1"> B. &lt;!-- comment --&gt;</label>
      <label><input type="radio" name="q3" value="2"> C. /* comment */</label>
      <label><input type="radio" name="q3" value="3"> D. * comment *</label>
    </div>

    <div class="question" id="q4">
      <strong>4. Where does the visible content of a webpage go?</strong>
      <label><input type="radio" name="q4" value="0"> A. &lt;html&gt;</label>
      <label><input type="radio" name="q4" value="1"> B. &lt;head&gt;</label>
      <label><input type="radio" name="q4" value="2"> C. &lt;body&gt;</label>
      <label><input type="radio" name="q4" value="3"> D. &lt;meta&gt;</label>
    </div>

    <div class="question" id="q5">
      <strong>5. HTML elements are defined using &lt;_______&gt; and &lt;/_______&gt; tags.</strong>
      <input type="text" id="a5" placeholder="Enter the answer">
    </div>

    <div class="question" id="q6">
      <strong>6. The proper placement of one HTML element inside another is called _______.</strong>
      <input type="text" id="a6" placeholder="Enter the answer">
    </div>

    <div class="question" id="q7">
      <strong>7. Comments in HTML are written using _______.</strong>
      <input type="text" id="a7" placeholder="Enter the answer">
    </div>

    <div class="question" id="q8">
      <strong>8. Identify the purpose of the &lt;html&gt; tag.</strong>
      <input type="text" id="a8" placeholder="Enter the answer">
    </div>

    <div class="question" id="q9">
      <strong>9. Identify the purpose of the &lt;head&gt; tag.</strong>
      <input type="text" id="a9" placeholder="Enter the answer">
    </div>

    <div class="question" id="q10">
      <strong>10. Identify the purpose of the &lt;body&gt; tag.</strong>
      <input type="text" id="a10" placeholder="Enter the answer">
    </div>

    <button class="next" id="submitBtn">Submit Answers</button>
  </div>

  <div class="ground"></div>
  <footer>Â© 2025 MindCraft | Kuya AJ & Team</footer>
</div>

<!-- XP Popup (overlay) -->
<div id="popupOverlay" aria-hidden="true">
  <div class="popup-card">
    <h2>ðŸŽ‰ Lesson Complete!</h2>
    <p id="xpGain">+0 XP Gained</p>
    <div class="xp-bar-container"><div class="xp-bar-fill" id="xpBarFill"></div></div>
    <button id="backBtn">â¬… Back to Lobby</button>
  </div>
</div>

<!-- Sounds (paths must match your project) -->
<audio id="correctSound" src="../../../Assets/Sounds/Correct.mp3"></audio>
<audio id="wrongSound" src="../../../Assets/Sounds/Incorrect.mp3"></audio>

<!-- Firebase + Quiz logic -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// ---------- Firebase config (same as your other files) ----------
const firebaseConfig = {
  apiKey: "AIzaSyAQBwwuXwh82MCRyJ_7CBk2aWUp-n6p4DQ",
  authDomain: "mindcraft-83f81.firebaseapp.com",
  projectId: "mindcraft-83f81",
  storageBucket: "mindcraft-83f81.firebasestorage.app",
  messagingSenderId: "483019456762",
  appId: "1:483019456762:web:fdc05a2dda51c0f39a8943"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// ---------- Quiz correct answers (0-based indices / text answers) ----------
const ANSWERS_RADIO = {
  q1: 0, q2: 1, q3: 1, q4: 2
};
const ANSWERS_TEXT = {
  a5: ['element','tag','tags','html element'],      // accept some variants
  a6: ['nesting','nested','nesting elements'],
  a7: ['<!-- -->','!-- --','<!-- comment -->','<!--comment-->','<!--'],
  a8: ['root','root element','controls document','wraps all content'],
  a9: ['metadata','metadata container','contains title','links to css','contains metadata'],
  a10: ['visible content','page content','body content','holds visible content']
};

// ---------- XP reward table (per lesson number) ----------
const LESSON_XP_MAP = {
  1: 15, 2: 18, 3: 22, 4: 25, 5: 30,
  6: 35, 7: 40, 8: 45, 9: 50, 10: 60
};

// ---------- Helpers ----------
function normalizeTextAnswer(s) {
  return (s || '').toString().trim().toLowerCase().replace(/\s+/g,' ');
}
function matchesTextAnswer(input, acceptedArr) {
  if (!input) return false;
  const inp = normalizeTextAnswer(input);
  return acceptedArr.some(a => inp.includes(normalizeTextAnswer(a)));
}

// ---------- UI elements ----------
const submitBtn = document.getElementById('submitBtn');
const popupOverlay = document.getElementById('popupOverlay');
const xpGainEl = document.getElementById('xpGain');
const xpBarFill = document.getElementById('xpBarFill');
const backBtn = document.getElementById('backBtn');
const correctSound = document.getElementById('correctSound');
const wrongSound = document.getElementById('wrongSound');

let earnedXP = 0;
let soundEnabled = localStorage.getItem('sound') === 'on';
let vibrationEnabled = localStorage.getItem('vibration') === 'on';

// ---------- Read lesson param to pick XP reward ----------
function getLessonNumber() {
  try {
    const url = new URL(window.location.href);
    const l = url.searchParams.get('lesson');
    return l ? parseInt(l.replace(/\D/g,''),10) || 1 : 1;
  } catch(e){ return 1; }
}
const lessonNum = Math.max(1, Math.min(100, getLessonNumber()));
const XP_REWARD_FOR_LESSON = LESSON_XP_MAP[lessonNum] ?? 15;

// ---------- Auth check before allowing submit ----------
onAuthStateChanged(auth, (user) => {
  if (!user) {
    alert('âš ï¸ You must be signed in to take this lesson/quiz.');
    window.location.href = '../../../Account/signin.html';
    return;
  }
  // user is signed in â€” enable submit (we keep button enabled but check again during submit)
});

// ---------- Quiz scoring logic ----------
function gradeQuiz() {
  earnedXP = 0;
  // radio questions
  for (const q of Object.keys(ANSWERS_RADIO)) {
    const input = document.querySelector(`input[name="${q}"]:checked`);
    const correct = ANSWERS_RADIO[q];
    if (input && parseInt(input.value,10) === correct) {
      earnedXP += Math.round(XP_REWARD_FOR_LESSON /  (Object.keys(ANSWERS_RADIO).length + 1)); // split across radios
      if (soundEnabled) { try { correctSound.play(); } catch(e){} }
      if (vibrationEnabled && navigator.vibrate) navigator.vibrate(60);
    } else {
      if (soundEnabled) { try { wrongSound.play(); } catch(e){} }
    }
  }

  // text questions (weight heavier)
  const textKeys = Object.keys(ANSWERS_TEXT);
  for (const key of textKeys) {
    const val = document.getElementById(key)?.value;
    if (matchesTextAnswer(val, ANSWERS_TEXT[key])) {
      earnedXP += Math.round(XP_REWARD_FOR_LESSON / (textKeys.length + 1)); // slightly larger share
      if (soundEnabled) { try { correctSound.play(); } catch(e){} }
      if (vibrationEnabled && navigator.vibrate) navigator.vibrate(60);
    } else {
      if (soundEnabled) { try { wrongSound.play(); } catch(e){} }
    }
  }

  // clamp: at least 1 XP if anything correct, else 0; but also ensure not more than XP_REWARD_FOR_LESSON
  if (earnedXP > XP_REWARD_FOR_LESSON) earnedXP = XP_REWARD_FOR_LESSON;
  earnedXP = Math.max(0, Math.round(earnedXP));
}

// ---------- Submit flow: compute XP, update Firestore, show popup ----------
submitBtn.addEventListener('click', async () => {
  // grade locally
  gradeQuiz();

  // show immediate feedback if no XP earned
  if (earnedXP === 0) {
    // still show popup with 0 XP
    await showPopupAndSaveXP(0);
    return;
  }

  // update Firestore
  try {
    const user = auth.currentUser;
    if (!user) {
      alert('âš ï¸ You must be signed in (session expired).');
      window.location.href = '../../../Account/signin.html';
      return;
    }

    const userRef = doc(db, 'users', user.uid);
    const snap = await getDoc(userRef);
    if (!snap.exists()) {
      alert('âš ï¸ User record missing in Firestore.');
      return;
    }

    const data = snap.data();
    let oldXP = Number(data.xp || 0);
    let oldLevel = Number(data.level || 1);
    let xpMax = Number(data.xpMax || Math.floor(100 * Math.pow(1.1, oldLevel - 1)));

    // Add earnedXP (but cap final level increments using xpMax multiplier logic)
    let newXP = oldXP + earnedXP;
    let newLevel = oldLevel;

    while (newXP >= xpMax) {
      newXP -= xpMax;
      newLevel++;
      xpMax = Math.floor(100 * Math.pow(1.1, newLevel - 1));
    }

    // Save to Firestore
    await updateDoc(userRef, { xp: newXP, level: newLevel, xpMax: xpMax });

    // Also persist locally for offline UI
    try {
      localStorage.setItem(`${user.uid}_xp`, newXP);
      localStorage.setItem(`${user.uid}_level`, newLevel);
      localStorage.setItem(`${user.uid}_xpMax`, xpMax);
    } catch(e) {
      // ignore localStorage errors silently (space)
    }

    await showPopupAndSaveXP(earnedXP);

  } catch (err) {
    // show alert for visibility on mobile
    alert('âš ï¸ Error saving XP: ' + (err?.message || err));
    // still show popup (no saving)
    await showPopupAndSaveXP(earnedXP);
  }
});

// ---------- Popup / animation helper ----------
async function showPopupAndSaveXP(xpAmount) {
  xpGainEl.textContent = `+${xpAmount} XP Gained`;
  xpBarFill.style.width = '0%';
  popupOverlay.style.display = 'flex';
  popupOverlay.setAttribute('aria-hidden','false');
  // animate bar to full width to feel good
  setTimeout(() => xpBarFill.style.width = '100%', 140);
}

// ---------- Back to lobby button ----------
backBtn.addEventListener('click', () => {
  popupOverlay.classList.add('fade-out');
  setTimeout(() => { window.location.href = '../../../Webside/Student.html'; }, 650);
});

// ---------- Optional:  automatic finish after time expires ----------
// (not necessary here but you can reuse a timer implementation if needed)

</script>
</body>
</html>
